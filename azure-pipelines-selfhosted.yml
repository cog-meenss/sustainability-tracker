# Azure DevOps Pipeline for Carbon Footprint Analysis (Self-Hosted Agent Version)
# Use this version if you want to run on a self-hosted agent instead of requesting hosted parallelism

trigger:
- main
- master
- develop

variables:
  # Carbon threshold in kg CO2 - pipeline will show warning if exceeded
  CARBON_THRESHOLD: '0.1'
  
pool:
  name: 'Default'  # Self-hosted agent pool (change to your pool name)
  # vmImage: 'ubuntu-latest'  # Commented out - using self-hosted instead

stages:
- stage: CarbonFootprintAnalysis
  displayName: 'Carbon Footprint Analysis'
  jobs:
  - job: AnalyzeProject
    displayName: 'Analyze Project Carbon Footprint'
    
    steps:
    - checkout: self
      displayName: 'Checkout Repository'
      
    - script: |
        echo "üåç CARBON FOOTPRINT ANALYSIS PIPELINE (Self-Hosted)"
        echo "=================================================="
        echo "Repository: $(Build.Repository.Name)"
        echo "Branch: $(Build.SourceBranchName)"
        echo "Commit: $(Build.SourceVersion)"
        echo "Threshold: $(CARBON_THRESHOLD) kg CO2"
        echo "Agent: Self-Hosted"
        echo ""
      displayName: 'Pipeline Information'
      
    - script: |
        # Check Python availability
        python3 --version || python --version
        
        # Install dependencies if needed
        python3 -m pip install --user requests pyyaml 2>/dev/null || pip3 install requests pyyaml
      displayName: 'Setup Dependencies'
      
    - script: |
        # Create carbon reports directory
        mkdir -p carbon-reports
        
        # Navigate to analyzer directory
        cd carbon-footprint-analyzer
        
        echo "üîç Starting Carbon Footprint Analysis..."
        echo "========================================"
        
        # Run the carbon footprint analyzer
        python3 cli.py .. --output ../carbon-reports --format json html --detailed
        
      displayName: 'Run Carbon Footprint Analysis'
      
    - script: |
        cd carbon-footprint-analyzer
        
        # Extract key metrics using helper script
        python3 pipeline_helper.py
        
      displayName: 'Show Analysis Results'
      
    - script: |
        # Check if analysis completed successfully
        if [ -f "carbon-reports/complete_analysis.json" ]; then
          cd carbon-footprint-analyzer
          python3 pipeline_helper.py --set-variables
        fi
      displayName: 'Set Pipeline Summary'
      name: CarbonResults

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Carbon Footprint HTML Report'
      inputs:
        pathToPublish: '$(System.DefaultWorkingDirectory)/carbon-reports'
        artifactName: 'carbon-footprint-html-reports'
        publishLocation: 'Container'
      condition: always()
      
    - task: PublishPipelineArtifact@1
      displayName: 'Archive Carbon Reports'
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/carbon-reports'
        artifact: 'carbon-footprint-reports'
      condition: always()
      
    - script: |
        echo "üåê REPORT ACCESSIBILITY"
        echo "======================"
        echo "üìä HTML Reports available in Pipeline Artifacts"
        echo "üìã JSON Data available for downstream processing"
        echo "üîç Detailed analysis available in published artifacts"
        echo ""
        echo "üîó Access Reports:"
        echo "   1. Go to Pipeline Summary ‚Üí Artifacts section"
        echo "   2. Download 'carbon-footprint-html-reports' artifact"
        echo "   3. Download 'carbon-footprint-reports' artifact"  
        echo "   4. Open complete_analysis.html for interactive dashboard"
        echo ""
        
      displayName: 'Report Access Information'

- stage: DisplaySummary
  displayName: 'Pipeline Summary'
  dependsOn: CarbonFootprintAnalysis
  condition: always()
  jobs:
  - job: ShowSummary
    displayName: 'Show Carbon Analysis Summary'
    variables:
      CarbonFootprint: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.CarbonFootprint'] ]
      EnergyUsage: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.EnergyUsage'] ]
      FilesAnalyzed: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.FilesAnalyzed'] ]
      PrimaryLanguage: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.PrimaryLanguage'] ]
    
    steps:
    - script: |
        echo ""
        echo "üéØ CARBON ANALYSIS PIPELINE SUMMARY"
        echo "===================================="
        echo "Carbon Footprint: $(CarbonFootprint) kg CO2"
        echo "Energy Usage:     $(EnergyUsage) kWh"
        echo "Files Analyzed:   $(FilesAnalyzed)"
        echo "Primary Language: $(PrimaryLanguage)"
        echo ""
        echo "Threshold:        $(CARBON_THRESHOLD) kg CO2"
        
        # Simple comparison (works on both Linux and macOS)
        if [ "$(CarbonFootprint)" != "0" ]; then
          echo "Status: Analysis completed successfully"
          echo ""
          echo "üìã For detailed analysis, download the artifacts from the Pipeline Summary"
          echo "   ‚Üí Artifacts: 'carbon-footprint-html-reports' and 'carbon-footprint-reports'"
        else
          echo "Status: Please check analysis results"
        fi
        
        echo "===================================="
        echo ""
        
      displayName: 'Pipeline Summary'
      condition: always()