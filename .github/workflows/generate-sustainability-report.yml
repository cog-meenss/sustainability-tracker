name: Sustainability Analysis & GitHub Pages Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.9'
  REPORT_PATH: 'sustainability-reports'

jobs:
  sustainability-analysis:
    name: Sustainability Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
      deployments: write
      pull-requests: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon xenon bandit safety pylint flake8
        pip install requests psutil flask flask-cors
    - name: Run Analysis
      id: analysis
      run: |
        mkdir -p ${{ env.REPORT_PATH }}
        if [ -f "sustainability_evaluator.py" ]; then
          chmod +x sustainability_evaluator.py
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OUTPUT_BASE="report-${TIMESTAMP}"
          python3 sustainability_evaluator.py --path . --format html --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" || true
          python3 sustainability_evaluator.py --path . --format json --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" || true
          DASHBOARD_FILE=$(ls -t sustainability_dashboard_Tracker_*.html 2>/dev/null | head -n 1)
          if [ -f "$DASHBOARD_FILE" ]; then
            cp "$DASHBOARD_FILE" "${{ env.REPORT_PATH }}/latest-report.html"
          elif [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" "${{ env.REPORT_PATH }}/latest-report.html"
          fi
          if [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" "${{ env.REPORT_PATH }}/latest-report.json"
            SCORE=$(python3 -c "import json; data=json.load(open('${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json')); print(data.get('overall_score', 75))" 2>/dev/null || echo "75")
          else
            SCORE="75"
          fi
          echo "overall_score=$SCORE" >> $GITHUB_OUTPUT
          echo "Analysis completed - Score: $SCORE/100"
        else
          echo "sustainability_evaluator.py not found"
          exit 1
        fi
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v5
      if: github.ref == 'refs/heads/main'
    - name: Create Dashboard
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p pages/sustainability-reports
        # Copy all reports to the correct subfolder for GitHub Pages
        cp -r ${{ env.REPORT_PATH }}/* pages/sustainability-reports/ 2>/dev/null || true
        # Copy index.html to root of pages
        if [ -f "index.html" ]; then
          cp index.html pages/
        else
          echo '<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Green Coding - Sustainability Dashboard</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; display: flex; align-items: center; justify-content: center; }
                  .container { text-align: center; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 3rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); max-width: 800px; margin: 2rem; }
                  h1 { font-size: 3.5rem; margin-bottom: 1rem; background: linear-gradient(45deg, #fff, #e0e0e0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
                  .subtitle { font-size: 1.3rem; opacity: 0.9; margin-bottom: 2rem; }
                  .dashboard-btn { display: inline-block; background: linear-gradient(45deg, #4CAF50, #45a049); color: white; padding: 1.2rem 2.5rem; text-decoration: none; border-radius: 50px; font-weight: 600; font-size: 1.2rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); margin: 1rem; }
                  .dashboard-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6); }
                  .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
                  .feature { background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: 15px; transition: all 0.3s ease; }
                  .feature:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.15); }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Green Coding Academy</h1>
                  <p class="subtitle">Sustainability Analysis & Environmental Impact Dashboard</p>
                  <a href="sustainability-reports/latest-report.html" class="dashboard-btn">View Sustainability Dashboard</a>
                  <div class="features">
                      <div class="feature"><h3>Carbon Analysis</h3><p>Track COâ‚‚ emissions and environmental impact</p></div>
                      <div class="feature"><h3>âš¡ Performance Metrics</h3><p>Monitor efficiency with spider web charts</p></div>
                      <div class="feature"><h3>Benchmarks</h3><p>Compare against industry standards</p></div>
                      <div class="feature"><h3>Green Practices</h3><p>96+ sustainable coding patterns</p></div>
                  </div>
                  <p style="margin-top: 2rem; font-size: 0.9rem; opacity: 0.8;">Auto-generated sustainability reports</p>
              </div>
          </body>
          </html>' > pages/index.html
        fi
    - name: Deploy to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      if: github.ref == 'refs/heads/main'
      with:
        path: pages/
    - name: Publish GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      if: github.ref == 'refs/heads/main'
    - name: Set Deployment Output
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Setting deployment output for environment visibility"
        echo "page_url=${{ steps.deployment.outputs.page_url }}" >> $GITHUB_OUTPUT
        echo "report_url=${{ steps.deployment.outputs.page_url }}sustainability-reports/latest-report.html" >> $GITHUB_OUTPUT
    - name: Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: sustainability-reports-${{ github.sha }}
        path: ${{ env.REPORT_PATH }}/*
        retention-days: 30
    - name: Display GitHub Pages URL
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "GitHub Pages Deployed Successfully!"
        echo "Dashboard URL: ${{ steps.deployment.outputs.page_url }}"
        echo "Direct Report: ${{ steps.deployment.outputs.page_url }}sustainability-reports/latest-report.html"
        echo "Artifacts uploaded for commit: ${{ github.sha }}"
        DASHBOARD_FILE=$(ls -t sustainability_dashboard_Tracker_*.html 2>/dev/null | head -n 1)
        if [ -n "$DASHBOARD_FILE" ]; then
          REPORT_URL="${{ steps.deployment.outputs.page_url }}sustainability-reports/$DASHBOARD_FILE"
          REPORT_LABEL="$DASHBOARD_FILE"
        else
          REPORT_URL="${{ steps.deployment.outputs.page_url }}sustainability-reports/latest-report.html"
          REPORT_LABEL="latest-report.html"
        fi
        echo "## Sustainability Dashboard Deployed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo " **Deployment Status:** Success" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo " **Main Dashboard:** [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo " **Latest Report:** [$REPORT_LABEL]($REPORT_URL)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo " **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
    - name: PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        SCORE: ${{ steps.analysis.outputs.overall_score }}
      with:
        script: |
          const score = process.env.SCORE || '75';
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸŒ± **Sustainability Analysis Complete** - Score: ${score}/100`
          });
