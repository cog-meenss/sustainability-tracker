name: Comprehensive Sustainability Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:

env:
  SUSTAINABILITY_THRESHOLD: 75
  PYTHON_VERSION: '3.9'

jobs:
  comprehensive-sustainability:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Python Environment  
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Analysis Dependencies
      run: |
        echo "Installing runtime analysis dependencies..."
        python -m pip install --upgrade pip
        pip install radon xenon bandit safety pylint flake8 mypy
        echo "Dependencies installed successfully"
        
    - name: Generate Comprehensive Sustainability Report
      id: comprehensive_analysis
      run: |
        echo "Generating comprehensive sustainability evaluation with advanced visualizations..."
        
        # Make comprehensive evaluator executable
        chmod +x sustainability_evaluator.py
        chmod +x sustainability-analyzer/analyzer/sustainability_analyzer.py
        
        # Generate comprehensive report in multiple formats
        echo "Generating comprehensive JSON report..."
        python3 sustainability_evaluator.py --path . --format json --output comprehensive_sustainability_data.json
        
        echo "Generating comprehensive HTML report with charts and visualizations..."
        python3 sustainability_evaluator.py --path . --format html --output comprehensive_sustainability_report.html
        
        echo "Comprehensive evaluation completed successfully"
        ls -la comprehensive_sustainability_*
        
        # Extract metrics for GitHub Actions summary
        if [ -f comprehensive_sustainability_data.json ]; then
          OVERALL_SCORE=$(python3 -c "
        import json
        with open('comprehensive_sustainability_data.json') as f:
            data = json.load(f)
        print(f'{data[\"sustainability_metrics\"][\"overall_score\"]:.1f}')
        ")
          
          ENERGY_SCORE=$(python3 -c "
        import json
        with open('comprehensive_sustainability_data.json') as f:
            data = json.load(f)
        print(f'{data[\"sustainability_metrics\"][\"energy_efficiency\"]:.1f}')
        ")
          
          RESOURCE_SCORE=$(python3 -c "
        import json
        with open('comprehensive_sustainability_data.json') as f:
            data = json.load(f)
        print(f'{data[\"sustainability_metrics\"][\"resource_utilization\"]:.1f}')
        ")
          
          PERFORMANCE_ISSUES=$(python3 -c "
        import json
        with open('comprehensive_sustainability_data.json') as f:
            data = json.load(f)
        issues = 0
        if 'detailed_analysis' in data and 'code_patterns' in data['detailed_analysis']:
            patterns = data['detailed_analysis']['code_patterns']
            issues += patterns.get('async_patterns', 0)
            issues += patterns.get('loop_optimizations', 0)
            issues += patterns.get('memory_leaks', 0)
            issues += patterns.get('console_logs', 0)
        print(issues)
        ")
          
          CARBON_FOOTPRINT=$(python3 -c "
        import json
        with open('comprehensive_sustainability_data.json') as f:
            data = json.load(f)
        print(f'{data[\"sustainability_metrics\"][\"carbon_footprint\"]:.1f}')
        ")
          
          GENERATION_TIME=$(python3 -c "
        import json
        with open('comprehensive_sustainability_data.json') as f:
            data = json.load(f)
        print(f'{data[\"report_metadata\"][\"analysis_time\"]:.3f}')
        ")
          
          echo "overall_score=$OVERALL_SCORE" >> $GITHUB_OUTPUT
          echo "energy_score=$ENERGY_SCORE" >> $GITHUB_OUTPUT
          echo "resource_score=$RESOURCE_SCORE" >> $GITHUB_OUTPUT
          echo "performance_issues=$PERFORMANCE_ISSUES" >> $GITHUB_OUTPUT
          echo "carbon_footprint=$CARBON_FOOTPRINT" >> $GITHUB_OUTPUT
          echo "generation_time=$GENERATION_TIME" >> $GITHUB_OUTPUT
          
          echo "Comprehensive analysis completed in ${GENERATION_TIME}s"
          echo "Overall Score: $OVERALL_SCORE/100"
          echo "Performance Issues Detected: $PERFORMANCE_ISSUES"
          echo "Carbon Footprint Score: $CARBON_FOOTPRINT/100"
        else
          echo "Comprehensive analysis failed"
          exit 1
        fi
        
    - name: Quality Gate Evaluation
      run: |
        echo "Evaluating sustainability quality gate..."
        
        # Extract scores from comprehensive analysis
        OVERALL_SCORE=$(python3 -c "
        import json
        with open('comprehensive_sustainability_data.json', 'r') as f:
            data = json.load(f)
        print(data['sustainability_metrics']['overall_score'])
        ")
        
        THRESHOLD=${{ env.SUSTAINABILITY_THRESHOLD }}
        
        echo "Overall Score: $OVERALL_SCORE"
        echo "Required Threshold: $THRESHOLD"
        
        # Set outputs for other steps
        echo "SUSTAINABILITY_SCORE=$OVERALL_SCORE" >> $GITHUB_ENV
        
        if (( $(echo "$OVERALL_SCORE >= $THRESHOLD" | bc -l) )); then
          echo "Sustainability quality gate PASSED!"
          echo "QUALITY_GATE_PASSED=true" >> $GITHUB_ENV
        else
          echo "Sustainability quality gate FAILED!"
          echo "Score ($OVERALL_SCORE) is below threshold ($THRESHOLD)"
          echo "QUALITY_GATE_PASSED=false" >> $GITHUB_ENV
        fi
        
    - name: Create Comprehensive Job Summary
      run: |
        echo "Creating comprehensive GitHub Actions job summary with advanced metrics..."
        
        # Extract key metrics from comprehensive report
        python3 job_summary_script.py
        
    - name: Upload Comprehensive Reports
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-reports
        path: |
          comprehensive_sustainability_data.json
          comprehensive_sustainability_report.html
          COMPREHENSIVE_SUSTAINABILITY_SUMMARY.md
        retention-days: 30
        
    - name: Comment on PR (Comprehensive Analysis)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const analysis = JSON.parse(fs.readFileSync('comprehensive_sustainability_data.json', 'utf8'));
          
          const metrics = analysis.sustainability_metrics;
          const patterns = analysis.detailed_analysis?.code_patterns || {};
          const metadata = analysis.report_metadata;
          
          const comment = `## ğŸŒ± Comprehensive Sustainability Analysis Results
          
          ### Overall Score: ${metrics.overall_score.toFixed(1)}/100 ${metrics.overall_score >= 75 ? 'âœ…' : 'âŒ'}
          
          **Quality Gate:** ${metrics.overall_score >= 75 ? 'âœ… PASSED' : 'âŒ FAILED'} (Threshold: 75)  
          **Analysis Time:** ${metadata.analysis_time.toFixed(3)}s | **Issues Detected:** ${(patterns.async_patterns || 0) + (patterns.loop_optimizations || 0) + (patterns.console_logs || 0)}
          
          | Metric | Score | Status |
          |--------|-------|--------|
          | Energy Efficiency | ${metrics.energy_efficiency.toFixed(1)}/100 | ${metrics.energy_efficiency >= 70 ? 'âœ…' : metrics.energy_efficiency >= 40 ? 'âš ï¸' : 'âŒ'} |
          | Resource Utilization | ${metrics.resource_utilization.toFixed(1)}/100 | ${metrics.resource_utilization >= 70 ? 'âœ…' : metrics.resource_utilization >= 40 ? 'âš ï¸' : 'âŒ'} |
          | Code Maintainability | ${metrics.maintainability.toFixed(1)}/100 | ${metrics.maintainability >= 70 ? 'âœ…' : metrics.maintainability >= 40 ? 'âš ï¸' : 'âŒ'} |
          | Code Quality | ${metrics.code_quality.toFixed(1)}/100 | ${metrics.code_quality >= 70 ? 'âœ…' : metrics.code_quality >= 40 ? 'âš ï¸' : 'âŒ'} |
          
          ### ğŸŒ Environmental Impact
          - **Carbon Footprint Score:** ${metrics.carbon_footprint.toFixed(1)}/100
          - **Energy Efficiency:** ${metrics.energy_efficiency.toFixed(1)}/100
          - **Sustainable Practices:** ${metrics.sustainable_practices.toFixed(1)}/100
          
          ### ğŸš¨ Code Pattern Analysis
          - **Loop Patterns:** ${patterns.loop_optimizations || 0}
          - **Async Operations:** ${patterns.async_patterns || 0} 
          - **Console Logs:** ${patterns.console_logs || 0}
          - **Memory Leaks:** ${patterns.memory_leaks || 0}
          
          **Files Analyzed:** 30 â€¢ **Generated:** ${metadata.generated_at.substring(0, 19)}
          
          ğŸŒ± *Comprehensive analysis with advanced visualizations and carbon impact assessment*
          
          [ğŸ“Š View Interactive Dashboard](../actions/runs/` + context.runId + `) â€¢ [ğŸ“ˆ Download Full Reports](../actions/runs/` + context.runId + `)`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Fail if Quality Gate Failed
      if: env.QUALITY_GATE_PASSED == 'false'
      run: |
        echo "Failing build due to sustainability quality gate failure"
        echo "Check the recommendations in the analysis report"
        exit 1