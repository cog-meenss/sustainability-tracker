name: Automated Sustainability Analysis & Report Generation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.py'
      - '**/*.js'
      - '**/*.ts'
      - '**/*.jsx'
      - '**/*.tsx'
      - '**/*.java'
      - '**/*.cpp'
      - '**/*.c'
      - '**/*.cs'
      - '**/*.go'
      - '**/*.rs'
      - '**/*.php'
      - '**/*.rb'
      - 'package.json'
      - 'requirements.txt'
      - 'Dockerfile'
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.py'
      - '**/*.js'
      - '**/*.ts'
      - '**/*.jsx'
      - '**/*.tsx'
  workflow_dispatch:
    inputs:
      analysis_path:
        description: 'Path to analyze (default: entire repo)'
        required: false
        default: '.'
      output_name:
        description: 'Custom output filename'
        required: false
        default: 'sustainability-report'

env:
  PYTHON_VERSION: '3.9'
  REPORT_PATH: 'sustainability-reports'

jobs:
  sustainability-analysis:
    name: ğŸŒ± Generate Sustainability Report
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
      deployments: write
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests psutil
        # Install optional Flask dependencies for API features
        pip install flask flask-cors || echo "âš ï¸ Flask optional dependencies not installed"
        
    - name: ğŸ” Verify Sustainability Evaluator
      run: |
        if [ ! -f "sustainability_evaluator.py" ]; then
          echo "âŒ sustainability_evaluator.py not found in repository"
          exit 1
        fi
        echo "âœ… Sustainability evaluator found"
        
    - name: ğŸ“Š Create Reports Directory
      run: |
        mkdir -p ${{ env.REPORT_PATH }}
        echo "ğŸ“ Created reports directory: ${{ env.REPORT_PATH }}"
        
    - name: ğŸŒ± Run Sustainability Analysis
      id: analysis
      run: |
        echo "ğŸš€ Starting comprehensive sustainability analysis..."
        
        # Set analysis path (from workflow input or default)
        ANALYSIS_PATH="${{ github.event.inputs.analysis_path || '.' }}"
        
        # Set output filename with timestamp
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        if [ "${{ github.event.inputs.output_name }}" != "" ]; then
          OUTPUT_BASE="${{ github.event.inputs.output_name }}"
        else
          OUTPUT_BASE="sustainability-report-${COMMIT_SHA}-${TIMESTAMP}"
        fi
        
        HTML_OUTPUT="${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html"
        JSON_OUTPUT="${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json"
        
        # Run sustainability analysis with both HTML and JSON outputs
        python3 sustainability_evaluator.py \
          --path "${ANALYSIS_PATH}" \
          --format both \
          --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}"
        
        # Verify outputs were created
        if [ -f "$HTML_OUTPUT" ]; then
          echo "âœ… HTML report generated: $HTML_OUTPUT"
          echo "html_report=$HTML_OUTPUT" >> $GITHUB_OUTPUT
        else
          echo "âŒ HTML report generation failed"
          exit 1
        fi
        
        if [ -f "$JSON_OUTPUT" ]; then
          echo "âœ… JSON report generated: $JSON_OUTPUT"
          echo "json_report=$JSON_OUTPUT" >> $GITHUB_OUTPUT
        fi
        
        # Extract key metrics for summary
        OVERALL_SCORE=$(python3 -c "
import json
try:
    with open('$JSON_OUTPUT') as f:
        data = json.load(f)
        print(f\"{data['sustainability_metrics']['overall_score']:.1f}\")
except: print('N/A')
        ")
        
        ENERGY_EFFICIENCY=$(python3 -c "
import json
try:
    with open('$JSON_OUTPUT') as f:
        data = json.load(f)
        print(f\"{data['sustainability_metrics']['energy_efficiency']:.1f}\")
except: print('N/A')
        ")
        
        GREEN_SCORE=$(python3 -c "
import json
try:
    with open('$JSON_OUTPUT') as f:
        data = json.load(f)
        print(f\"{data['sustainability_metrics'].get('green_coding_score', 0):.1f}\")
except: print('N/A')
        ")
        
        RECOMMENDATIONS_COUNT=$(python3 -c "
import json
try:
    with open('$JSON_OUTPUT') as f:
        data = json.load(f)
        print(len(data.get('recommendations', [])))
except: print('0')
        ")
        
        # Set outputs for later steps
        echo "overall_score=$OVERALL_SCORE" >> $GITHUB_OUTPUT
        echo "energy_efficiency=$ENERGY_EFFICIENCY" >> $GITHUB_OUTPUT
        echo "green_score=$GREEN_SCORE" >> $GITHUB_OUTPUT
        echo "recommendations_count=$RECOMMENDATIONS_COUNT" >> $GITHUB_OUTPUT
        echo "output_base=$OUTPUT_BASE" >> $GITHUB_OUTPUT
        
    - name: ğŸ“ˆ Generate Analysis Summary
      id: summary
      run: |
        echo "ğŸ“Š Generating analysis summary..."
        
        # Create a comprehensive summary file
        SUMMARY_FILE="${{ env.REPORT_PATH }}/analysis-summary.md"
        
        cat > "$SUMMARY_FILE" << EOF
        # ğŸŒ± Sustainability Analysis Report
        
        **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
        **Commit:** \`${{ github.sha }}\`  
        **Branch:** \`${{ github.ref_name }}\`  
        **Triggered by:** ${{ github.event_name }}
        
        ## ğŸ“Š Key Metrics
        
        | Metric | Score | Status |
        |--------|-------|--------|
        | **Overall Sustainability** | ${{ steps.analysis.outputs.overall_score }}/100 | $([ $(echo "${{ steps.analysis.outputs.overall_score }} >= 80" | bc -l) -eq 1 ] && echo "ğŸŸ¢ Excellent" || [ $(echo "${{ steps.analysis.outputs.overall_score }} >= 60" | bc -l) -eq 1 ] && echo "ğŸŸ¡ Good" || echo "ğŸ”´ Needs Improvement") |
        | **Energy Efficiency** | ${{ steps.analysis.outputs.energy_efficiency }}/100 | $([ $(echo "${{ steps.analysis.outputs.energy_efficiency }} >= 80" | bc -l) -eq 1 ] && echo "ğŸŸ¢ Excellent" || [ $(echo "${{ steps.analysis.outputs.energy_efficiency }} >= 60" | bc -l) -eq 1 ] && echo "ğŸŸ¡ Good" || echo "ğŸ”´ Needs Improvement") |
        | **Green Coding Score** | ${{ steps.analysis.outputs.green_score }}/100 | $([ $(echo "${{ steps.analysis.outputs.green_score }} >= 80" | bc -l) -eq 1 ] && echo "ğŸŸ¢ Excellent" || [ $(echo "${{ steps.analysis.outputs.green_score }} >= 60" | bc -l) -eq 1 ] && echo "ğŸŸ¡ Good" || echo "ğŸ”´ Needs Improvement") |
        | **Recommendations** | ${{ steps.analysis.outputs.recommendations_count }} items | $([ ${{ steps.analysis.outputs.recommendations_count }} -eq 0 ] && echo "ğŸŸ¢ No Issues" || [ ${{ steps.analysis.outputs.recommendations_count }} -le 5 ] && echo "ğŸŸ¡ Minor Issues" || echo "ğŸ”´ Major Issues") |
        
        ## ğŸ“ Generated Reports
        
        - ğŸ¯ **Interactive Dashboard:** [\`${{ steps.analysis.outputs.output_base }}.html\`](${{ steps.analysis.outputs.html_report }})
        - ğŸ“‹ **JSON Data:** [\`${{ steps.analysis.outputs.output_base }}.json\`](${{ steps.analysis.outputs.json_report }})
        
        ## ğŸ¯ Quick Actions
        
        - View the interactive dashboard for detailed analysis
        - Check file-specific recommendations with line numbers
        - Review green coding suggestions for energy efficiency
        - Monitor carbon footprint metrics and projections
        
        ---
        *Generated by Automated Sustainability Analysis Workflow*
        EOF
        
        echo "summary_file=$SUMMARY_FILE" >> $GITHUB_OUTPUT
        
    - name: ğŸ—ï¸ Setup GitHub Pages
      uses: actions/configure-pages@v3
      if: github.ref == 'refs/heads/main'
      
    - name: ğŸŒ Prepare GitHub Pages Content
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ“„ Preparing GitHub Pages content..."
        
        # Create pages directory
        mkdir -p pages
        
        # Copy all reports to pages directory
        cp -r ${{ env.REPORT_PATH }}/* pages/ 2>/dev/null || true
        
        # Create an index.html for easy navigation
        cat > pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ğŸŒ± Sustainability Reports Dashboard</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    padding: 20px;
                }
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    background: white;
                    border-radius: 20px;
                    padding: 40px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                }
                .header {
                    text-align: center;
                    margin-bottom: 40px;
                }
                .header h1 {
                    color: #2c3e50;
                    font-size: 3em;
                    margin-bottom: 10px;
                }
                .header p {
                    color: #7f8c8d;
                    font-size: 1.2em;
                }
                .reports-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                    gap: 30px;
                    margin-bottom: 40px;
                }
                .report-card {
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                    border-radius: 15px;
                    padding: 30px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                    border-left: 5px solid #27ae60;
                }
                .report-card:hover {
                    transform: translateY(-10px);
                    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
                }
                .report-card h3 {
                    color: #2c3e50;
                    margin-bottom: 15px;
                    font-size: 1.5em;
                }
                .report-card p {
                    color: #7f8c8d;
                    margin-bottom: 20px;
                    line-height: 1.6;
                }
                .btn {
                    display: inline-block;
                    background: linear-gradient(135deg, #27ae60, #2ecc71);
                    color: white;
                    padding: 12px 25px;
                    border-radius: 25px;
                    text-decoration: none;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    margin-right: 10px;
                    margin-bottom: 10px;
                }
                .btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
                }
                .btn.secondary {
                    background: linear-gradient(135deg, #3498db, #2980b9);
                }
                .btn.secondary:hover {
                    box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
                }
                .stats {
                    background: linear-gradient(135deg, #2c3e50, #34495e);
                    color: white;
                    border-radius: 15px;
                    padding: 30px;
                    text-align: center;
                }
                .stats h2 {
                    margin-bottom: 20px;
                }
                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                }
                .stat-item {
                    background: rgba(255,255,255,0.1);
                    padding: 20px;
                    border-radius: 10px;
                }
                .stat-number {
                    font-size: 2.5em;
                    font-weight: bold;
                    color: #2ecc71;
                }
                .stat-label {
                    font-size: 0.9em;
                    opacity: 0.8;
                }
                .info-box {
                    background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
                    border-left: 4px solid #27ae60;
                    padding: 20px;
                    border-radius: 10px;
                    margin: 20px 0;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>ğŸŒ± Sustainability Reports</h1>
                    <p>Automated Green Coding Analysis & Environmental Impact Assessment</p>
                </div>
        
        EOF
        
        # Add current report links dynamically
        LATEST_HTML=$(ls pages/*.html 2>/dev/null | grep -E "sustainability-report-.*\.html" | head -1 | xargs basename 2>/dev/null || echo "")
        LATEST_JSON=$(ls pages/*.json 2>/dev/null | grep -E "sustainability-report-.*\.json" | head -1 | xargs basename 2>/dev/null || echo "")
        
        if [ ! -z "$LATEST_HTML" ]; then
            cat >> pages/index.html << EOF
                <div class="reports-grid">
                    <div class="report-card">
                        <h3>ğŸ“Š Latest Interactive Dashboard</h3>
                        <p>Comprehensive sustainability analysis with real-time metrics, file-specific issues, and actionable recommendations.</p>
                        <a href="$LATEST_HTML" class="btn">ğŸ¯ View Dashboard</a>
                        <a href="$LATEST_JSON" class="btn secondary">ğŸ“‹ Raw Data (JSON)</a>
                    </div>
                    
                    <div class="report-card">
                        <h3>ğŸ”„ Auto-Generated Reports</h3>
                        <p>Reports are automatically generated on every commit and updated in real-time.</p>
                        <a href="https://github.com/${{ github.repository }}/actions" class="btn secondary">âš™ï¸ View Workflows</a>
                        <a href="https://github.com/${{ github.repository }}" class="btn">ğŸ“ Source Code</a>
                    </div>
                </div>
        EOF
        else
            cat >> pages/index.html << EOF
                <div class="info-box">
                    <h3>ğŸ“‹ No Reports Available Yet</h3>
                    <p>Sustainability reports will appear here after the first successful workflow run. Reports are generated automatically on every commit to the main branch.</p>
                </div>
        EOF
        fi
        
        # Add statistics and footer
        cat >> pages/index.html << EOF
                
                <div class="stats">
                    <h2>ğŸ“ˆ Report Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">${{ steps.analysis.outputs.overall_score || 'N/A' }}</div>
                            <div class="stat-label">Overall Score</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${{ steps.analysis.outputs.green_score || 'N/A' }}</div>
                            <div class="stat-label">Green Coding</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${{ steps.analysis.outputs.recommendations_count || '0' }}</div>
                            <div class="stat-label">Recommendations</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">$(date +%m/%d)</div>
                            <div class="stat-label">Last Updated</div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px; color: #7f8c8d;">
                    <p>Generated by <strong>Automated Sustainability Analysis</strong> â€¢ Updated $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>
                    <p>Commit: <code>${{ github.sha }}</code> â€¢ Branch: <code>${{ github.ref_name }}</code></p>
                </div>
            </div>
        </body>
        </html>
        EOF
        
        echo "âœ… GitHub Pages content prepared in pages/ directory"
        
    - name: ğŸš€ Deploy to GitHub Pages
      uses: actions/upload-pages-artifact@v2
      if: github.ref == 'refs/heads/main'
      with:
        path: pages/
        
    - name: ğŸŒ Publish GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      if: github.ref == 'refs/heads/main'
      
    - name: ğŸ“¤ Upload Reports as Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: sustainability-reports-${{ github.sha }}
        path: |
          ${{ env.REPORT_PATH }}/*.html
          ${{ env.REPORT_PATH }}/*.json
          ${{ env.REPORT_PATH }}/*.md
        retention-days: 30
        
    - name: ğŸ“ Commit Reports to Repository
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add generated reports
        git add ${{ env.REPORT_PATH }}/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "ğŸ“ No new reports to commit"
        else
          git commit -m "ğŸŒ± Auto-generated sustainability reports
          
          - Overall Score: ${{ steps.analysis.outputs.overall_score }}/100
          - Energy Efficiency: ${{ steps.analysis.outputs.energy_efficiency }}/100  
          - Green Coding: ${{ steps.analysis.outputs.green_score }}/100
          - Recommendations: ${{ steps.analysis.outputs.recommendations_count }} items
          
          Generated from commit: ${{ github.sha }}
          Analysis triggered by: ${{ github.event_name }}"
          
          git push
          echo "âœ… Reports committed and pushed to repository"
        fi
        
    - name: ğŸ’¬ Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summaryPath = '${{ steps.summary.outputs.summary_file }}';
          
          if (fs.existsSync(summaryPath)) {
            const summary = fs.readFileSync(summaryPath, 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸŒ± Sustainability Analysis Results\n\n${summary}\n\n---\n\n**ğŸŒ View Live Dashboard:** [Sustainability Reports](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)\n**ğŸ“¥ Download Reports:** [Sustainability Reports Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });`
          }
          
    - name: ğŸš¨ Quality Gates Check
      run: |
        echo "ğŸ” Checking sustainability quality gates..."
        
        OVERALL_SCORE=${{ steps.analysis.outputs.overall_score }}
        MIN_SCORE=50  # Minimum acceptable sustainability score
        
        if (( $(echo "$OVERALL_SCORE < $MIN_SCORE" | bc -l) )); then
          echo "âŒ Sustainability quality gate FAILED"
          echo "   Current score: $OVERALL_SCORE"  
          echo "   Required minimum: $MIN_SCORE"
          echo "   Please review the generated recommendations"
          exit 1
        else
          echo "âœ… Sustainability quality gate PASSED"
          echo "   Current score: $OVERALL_SCORE (>= $MIN_SCORE)"
        fi
        
    - name: ğŸ“Š Update Job Summary
      if: always()
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ğŸŒ± Sustainability Analysis Complete
        
        ## Results Overview
        - **Overall Score:** ${{ steps.analysis.outputs.overall_score }}/100
        - **Energy Efficiency:** ${{ steps.analysis.outputs.energy_efficiency }}/100
        - **Green Coding:** ${{ steps.analysis.outputs.green_score }}/100
        - **Recommendations:** ${{ steps.analysis.outputs.recommendations_count }} items
        
        ## Generated Artifacts
        - Interactive HTML Dashboard: \`${{ steps.analysis.outputs.output_base }}.html\`
        - Detailed JSON Report: \`${{ steps.analysis.outputs.output_base }}.json\`
        - Analysis Summary: \`analysis-summary.md\`
        
        ## ğŸ”— Quick Links
        - [ğŸŒ **View Live Dashboard** (GitHub Pages)](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)
        - [ğŸ“¥ Download Reports Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        - [ğŸ“Š View Workflow Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        ---
        *Analysis completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
        EOF