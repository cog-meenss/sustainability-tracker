name: ğŸŒ± Clean Sustainability Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday 2 AM
  workflow_dispatch:
    inputs:
      analysis_depth:
        description: 'Analysis depth'
        required: false
        default: 'standard'
        type: choice
        options:
        - quick
        - standard  
        - comprehensive

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  REPORT_PATH: 'sustainability-reports'
  MIN_SUSTAINABILITY_SCORE: 60

jobs:
  sustainability-analysis:
    name: ğŸŒ± Sustainability Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    permissions:
      contents: read
      pages: write
      id-token: write
      pull-requests: write
      
    outputs:
      sustainability_score: ${{ steps.analysis.outputs.sustainability_score }}
      quality_gate_passed: ${{ steps.analysis.outputs.quality_gate_passed }}
      recommendations_count: ${{ steps.analysis.outputs.recommendations_count }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ Setup Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸŸ¢ Setup Node.js Environment  
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Analysis Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon>=6.0.1 bandit>=1.7.5 safety>=2.3.0 
        pip install requests>=2.31.0 psutil>=5.9.0
        
    - name: ğŸŒ± Run Sustainability Analysis
      id: analysis
      run: |
        mkdir -p ${{ env.REPORT_PATH }}
        
        # Determine analysis depth
        ANALYSIS_DEPTH="${{ inputs.analysis_depth || 'standard' }}"
        echo "ğŸ¯ Analysis depth: $ANALYSIS_DEPTH"
        
        # Run sustainability analysis
        if [ -f "sustainability_evaluator.py" ]; then
          python3 sustainability_evaluator.py \
            --path . \
            --format both \
            --output "${{ env.REPORT_PATH }}/report" || echo "Analysis completed with warnings"
        else
          echo "âŒ sustainability_evaluator.py not found"
          exit 1
        fi
        
        # Extract results
        if [ -f "${{ env.REPORT_PATH }}/report.json" ]; then
          # Parse sustainability score
          SCORE=$(python3 -c 'import json; f=open("${{ env.REPORT_PATH }}/report.json"); data=json.load(f); print(f"{data.get(\"sustainability_metrics\", {}).get(\"overall_score\", 50):.1f}")' 2>/dev/null || echo "50.0")
          
          # Parse recommendations count  
          RECOMMENDATIONS=$(python3 -c 'import json; f=open("${{ env.REPORT_PATH }}/report.json"); data=json.load(f); print(len(data.get("recommendations", [])))' 2>/dev/null || echo "0")
          
          # Check quality gate
          if (( $(echo "$SCORE >= ${{ env.MIN_SUSTAINABILITY_SCORE }}" | bc -l 2>/dev/null || echo "0") )); then
            QUALITY_GATE="true"
            echo "âœ… Quality gate PASSED: $SCORE/${{ env.MIN_SUSTAINABILITY_SCORE }}"
          else
            QUALITY_GATE="false"
            echo "âŒ Quality gate FAILED: $SCORE/${{ env.MIN_SUSTAINABILITY_SCORE }}"
          fi
          
          # Set outputs
          echo "sustainability_score=$SCORE" >> $GITHUB_OUTPUT
          echo "recommendations_count=$RECOMMENDATIONS" >> $GITHUB_OUTPUT
          echo "quality_gate_passed=$QUALITY_GATE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Analysis Summary:"
          echo "  â€¢ Sustainability Score: $SCORE/100"
          echo "  â€¢ Recommendations: $RECOMMENDATIONS"
          echo "  â€¢ Quality Gate: $QUALITY_GATE"
        else
          echo "âŒ Analysis failed - no report generated"
          echo "sustainability_score=0" >> $GITHUB_OUTPUT
          echo "recommendations_count=0" >> $GITHUB_OUTPUT
          echo "quality_gate_passed=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ğŸ”’ Security Analysis
      continue-on-error: true
      run: |
        mkdir -p ${{ env.REPORT_PATH }}/security
        
        # Python security analysis
        if command -v bandit >/dev/null 2>&1; then
          echo "ğŸ”’ Running Python security analysis..."
          bandit -r . -f json -o ${{ env.REPORT_PATH }}/security/bandit-report.json \
            --exclude ".venv,node_modules,venv" || true
        fi
        
        # Dependency security check
        if [ -f "requirements.txt" ]; then
          echo "ğŸ” Checking Python dependencies..."
          safety check --json --output ${{ env.REPORT_PATH }}/security/safety-report.json || true
        fi
        
        # Node.js security analysis
        if [ -f "package.json" ] && command -v npm >/dev/null 2>&1; then
          echo "ğŸ”’ Running Node.js security analysis..."
          npm audit --json > ${{ env.REPORT_PATH }}/security/npm-audit.json 2>/dev/null || true
        fi
        
    - name: ğŸ“¤ Upload Analysis Results
      uses: actions/upload-artifact@v4
      with:
        name: sustainability-analysis-${{ github.sha }}
        path: ${{ env.REPORT_PATH }}/
        retention-days: 90
        
    - name: ğŸ’¬ PR Comment with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const score = '${{ steps.analysis.outputs.sustainability_score }}';
          const passed = '${{ steps.analysis.outputs.quality_gate_passed }}' === 'true';
          const recommendations = '${{ steps.analysis.outputs.recommendations_count }}';
          
          const emoji = passed ? 'âœ…' : 'âŒ';
          const status = passed ? 'PASSED' : 'FAILED';
          
          const body = `## ğŸŒ± Sustainability Analysis Results
          
          ${emoji} **Quality Gate ${status}**
          
          | Metric | Value | Status |
          |--------|-------|--------|
          | ğŸŒ± Sustainability Score | **${score}/100** | ${score >= 60 ? 'âœ…' : 'âŒ'} |
          | ğŸ’¡ Recommendations | **${recommendations}** | ${recommendations <= 5 ? 'âœ…' : 'âš ï¸'} |
          | ğŸ¯ Quality Threshold | **${{ env.MIN_SUSTAINABILITY_SCORE }}/100** | ${passed ? 'âœ…' : 'âŒ'} |
          
          ${passed ? 
            'ğŸ‰ Great work! Your code meets sustainability standards.' : 
            'ğŸ”§ Please review the sustainability recommendations to improve your score.'
          }
          
          ---
          *ğŸ¤– Generated by Clean Sustainability Pipeline*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  deploy-dashboard:
    name: ğŸš€ Deploy Dashboard
    needs: sustainability-analysis
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“Š Download Analysis Results
      uses: actions/download-artifact@v4
      with:
        name: sustainability-analysis-${{ github.sha }}
        path: dashboard/
        
    - name: ğŸŒ Setup GitHub Pages
      uses: actions/configure-pages@v5
      
    - name: ğŸ—ï¸ Build Dashboard
      run: |
        # Use existing report if available, otherwise create basic dashboard
        if [ -f "dashboard/report.html" ]; then
          cp dashboard/report.html dashboard/index.html
          echo "ğŸ“Š Using generated sustainability report as dashboard"
        else
          # Create simple dashboard page
          cat > dashboard/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ğŸŒ± Sustainability Dashboard</title>
            <style>
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
                margin: 0; padding: 40px; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh; color: white; 
              }
              .container {
                max-width: 800px; margin: 0 auto; 
                background: rgba(255,255,255,0.1); 
                padding: 40px; border-radius: 20px;
                backdrop-filter: blur(10px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
              }
              h1 { font-size: 2.5rem; margin-bottom: 1rem; text-align: center; }
              .metric { 
                background: rgba(255,255,255,0.2); 
                padding: 20px; margin: 20px 0; 
                border-radius: 10px; text-align: center; 
              }
              .score { font-size: 2rem; font-weight: bold; color: #2ecc71; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ğŸŒ± Sustainability Dashboard</h1>
              <div class="metric">
                <div class="score">${{ needs.sustainability-analysis.outputs.sustainability_score || 'N/A' }}/100</div>
                <div>Overall Sustainability Score</div>
              </div>
              <div class="metric">
                <div class="score">${{ needs.sustainability-analysis.outputs.recommendations_count || '0' }}</div>
                <div>Recommendations</div>
              </div>
              <div class="metric">
                <div class="score">${{ needs.sustainability-analysis.outputs.quality_gate_passed == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}</div>
                <div>Quality Gate Status</div>
              </div>
              <p style="text-align: center; margin-top: 40px; opacity: 0.8;">
                ğŸ¤– Generated automatically by Sustainability Pipeline
              </p>
            </div>
          </body>
          </html>
        EOF
          echo "ğŸ“„ Created basic dashboard page"
        fi
        
    - name: ğŸš€ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: dashboard/
        
    - name: ğŸŒ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4