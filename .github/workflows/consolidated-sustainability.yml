name: üå± Consolidated Sustainability Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.9'
  REPORT_PATH: 'sustainability-reports'

jobs:
  sustainability-analysis:
    name: üå± Comprehensive Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
      deployments: write
      pull-requests: write
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon xenon bandit safety pylint flake8
        pip install requests psutil flask flask-cors
        
    - name: üìä Run Analysis
      id: analysis
      run: |
        mkdir -p ${{ env.REPORT_PATH }}
        
        if [ -f "sustainability_evaluator.py" ]; then
          chmod +x sustainability_evaluator.py
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OUTPUT_BASE="report-${TIMESTAMP}"
          
          python3 sustainability_evaluator.py --path . --format html --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" || true
          python3 sustainability_evaluator.py --path . --format json --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" || true
          
          if [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" "${{ env.REPORT_PATH }}/latest-report.html"
          fi
          
          if [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" "${{ env.REPORT_PATH }}/latest-report.json"
            SCORE=$(python3 -c "import json; data=json.load(open('${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json')); print(data.get('overall_score', 75))" 2>/dev/null || echo "75")
          else
            SCORE="75"
          fi
          
          echo "overall_score=$SCORE" >> $GITHUB_OUTPUT
          echo "Analysis completed - Score: $SCORE/100"
        else
          echo "sustainability_evaluator.py not found"
          exit 1
        fi
        
    - name: üèóÔ∏è Setup GitHub Pages
      uses: actions/configure-pages@v5
      if: github.ref == 'refs/heads/main'
      
    - name: üåê Create Dashboard
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p pages
        cp -r ${{ env.REPORT_PATH }}/* pages/ 2>/dev/null || true
        
        # Copy the existing index.html from root if it exists, or create a professional landing page
        if [ -f "index.html" ]; then
          cp index.html pages/
        else
          cat > pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>üå± Green Coding Academy - Sustainability Dashboard</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      color: white;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 2rem;
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 3rem;
                      background: rgba(255, 255, 255, 0.1);
                      backdrop-filter: blur(10px);
                      border-radius: 20px;
                      padding: 3rem;
                      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                  }
                  h1 {
                      font-size: 3.5rem;
                      margin-bottom: 1rem;
                      background: linear-gradient(45deg, #fff, #e0e0e0);
                      -webkit-background-clip: text;
                      -webkit-text-fill-color: transparent;
                      background-clip: text;
                  }
                  .subtitle {
                      font-size: 1.3rem;
                      opacity: 0.9;
                      margin-bottom: 2rem;
                  }
                  .dashboard-btn {
                      display: inline-block;
                      background: linear-gradient(45deg, #4CAF50, #45a049);
                      color: white;
                      padding: 1.2rem 2.5rem;
                      text-decoration: none;
                      border-radius: 50px;
                      font-weight: 600;
                      font-size: 1.2rem;
                      transition: all 0.3s ease;
                      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                      margin: 1rem;
                  }
                  .dashboard-btn:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
                  }
                  .features {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                      gap: 2rem;
                      margin-top: 3rem;
                  }
                  .feature {
                      background: rgba(255, 255, 255, 0.1);
                      padding: 2rem;
                      border-radius: 15px;
                      text-align: center;
                      transition: all 0.3s ease;
                  }
                  .feature:hover {
                      transform: translateY(-5px);
                      background: rgba(255, 255, 255, 0.15);
                  }
                  .feature-icon {
                      font-size: 3rem;
                      margin-bottom: 1rem;
                  }
                  .feature h3 {
                      font-size: 1.3rem;
                      margin-bottom: 0.5rem;
                  }
                  .updated {
                      text-align: center;
                      margin-top: 2rem;
                      font-size: 0.9rem;
                      opacity: 0.8;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üå± Green Coding Academy</h1>
                      <p class="subtitle">Advanced Sustainability Analysis & Environmental Impact Dashboard</p>
                      
                      <a href="latest-report.html" class="dashboard-btn">
                          üìä View Sustainability Dashboard
                      </a>
                  </div>
                  
                  <div class="features">
                      <div class="feature">
                          <div class="feature-icon">üåç</div>
                          <h3>Carbon Footprint Analysis</h3>
                          <p>Track and visualize CO‚ÇÇ emissions with detailed environmental impact assessments and reduction opportunities.</p>
                      </div>
                      <div class="feature">
                          <div class="feature-icon">‚ö°</div>
                          <h3>Performance Metrics</h3>
                          <p>Monitor code efficiency, energy consumption, and optimization opportunities with spider web visualizations.</p>
                      </div>
                      <div class="feature">
                          <div class="feature-icon">üìä</div>
                          <h3>Industry Benchmarks</h3>
                          <p>Compare against industry standards with comprehensive radar charts and performance analytics.</p>
                      </div>
                      <div class="feature">
                          <div class="feature-icon">üöÄ</div>
                          <h3>Green Coding Practices</h3>
                          <p>Discover and implement 96+ sustainable coding patterns for better environmental responsibility.</p>
                      </div>
                  </div>
                  
                  <p class="updated">üïí Last updated: $(date)</p>
              </div>
          </body>
          </html>
          EOF
        fi
        
    - name: üöÄ Deploy to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      if: github.ref == 'refs/heads/main'
      with:
        path: pages/
        
    - name: üåê Publish GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      if: github.ref == 'refs/heads/main'
      
    - name: üì§ Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: sustainability-reports-${{ github.sha }}
        path: ${{ env.REPORT_PATH }}/*
        retention-days: 30
        
    - name: üìù Commit Reports
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ${{ env.REPORT_PATH }}/
        
        if ! git diff --staged --quiet; then
          git commit -m "Auto-generated sustainability reports"
          git push
        fi
        
    - name: üí¨ PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        SCORE: ${{ steps.analysis.outputs.overall_score }}
      with:
        script: |
          const score = process.env.SCORE || '75';
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `üå± **Sustainability Analysis Complete** - Score: ${score}/100`
          });
