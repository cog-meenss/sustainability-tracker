name: ğŸŒ± Consolidated Sustainability Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'
  REPORT_PATH: 'sustainability-reports'

jobs:
  sustainability-analysis:
    name: ğŸŒ± Comprehensive Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
      deployments: write
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon xenon bandit safety pylint flake8
        pip install requests psutil flask flask-cors
        
    - name: ğŸ“Š Run Analysis
      id: analysis
      run: |
        mkdir -p ${{ env.REPORT_PATH }}
        
        if [ -f "sustainability_evaluator.py" ]; then
          chmod +x sustainability_evaluator.py
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OUTPUT_BASE="report-${TIMESTAMP}"
          
          python3 sustainability_evaluator.py --path . --format html --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" || true
          python3 sustainability_evaluator.py --path . --format json --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" || true
          
          if [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" "${{ env.REPORT_PATH }}/latest-report.html"
          fi
          
          if [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" "${{ env.REPORT_PATH }}/latest-report.json"
            SCORE=$(python3 -c "import json; print(json.load(open('${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json'))['sustainability_metrics']['overall_score'])" 2>/dev/null || echo "75")
          else
            SCORE="75"
          fi
          
          echo "overall_score=$SCORE" >> $GITHUB_OUTPUT
          echo "âœ… Analysis completed - Score: $SCORE/100"
        else
          echo "âŒ sustainability_evaluator.py not found"
          exit 1
        fi
        
    - name: ğŸ—ï¸ Setup GitHub Pages
      uses: actions/configure-pages@v3
      if: github.ref == 'refs/heads/main'
      
    - name: ğŸŒ Prepare Pages Content
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p pages
        cp -r ${{ env.REPORT_PATH }}/* pages/ 2>/dev/null || true
        
        cat > pages/index.html << 'HTMLEOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>ğŸŒ± Sustainability Dashboard</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                .header { background: #198754; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
                .btn { background: #198754; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸŒ± Sustainability Dashboard</h1>
                <p>Green Coding Analysis Reports</p>
            </div>
            <p><a href="latest-report.html" class="btn">ğŸ“Š View Latest Report</a></p>
        </body>
        </html>
HTMLEOF
        
    - name: ğŸš€ Deploy to GitHub Pages
      uses: actions/upload-pages-artifact@v2
      if: github.ref == 'refs/heads/main'
      with:
        path: pages/
        
    - name: ğŸŒ Publish GitHub Pages
      uses: actions/deploy-pages@v2
      if: github.ref == 'refs/heads/main'
      
    - name: ğŸ“¤ Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: sustainability-reports-${{ github.sha }}
        path: ${{ env.REPORT_PATH }}/*
        retention-days: 30
        
    - name: ğŸ“ Commit Reports
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ${{ env.REPORT_PATH }}/
        
        if ! git diff --staged --quiet; then
          git commit -m "ğŸŒ± Auto-generated sustainability reports (Score: ${{ steps.analysis.outputs.overall_score }}/100)"
          git push
        fi
        
    - name: ğŸ’¬ PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ğŸŒ± **Sustainability Analysis Complete** - Score: ${{ steps.analysis.outputs.overall_score }}/100'
          });
