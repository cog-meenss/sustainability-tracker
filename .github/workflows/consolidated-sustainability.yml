name: ğŸŒ± Consolidated Sustainability Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.9'
  REPORT_PATH: 'sustainability-reports'

jobs:
  sustainability-analysis:
    name: ğŸŒ± Comprehensive Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
      deployments: write
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon xenon bandit safety pylint flake8
        pip install requests psutil flask flask-cors
        
    - name: ğŸ“Š Run Analysis
      id: analysis
      run: |
        mkdir -p ${{ env.REPORT_PATH }}
        
        if [ -f "sustainability_evaluator.py" ]; then
          chmod +x sustainability_evaluator.py
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OUTPUT_BASE="report-${TIMESTAMP}"
          
          python3 sustainability_evaluator.py --path . --format html --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" || true
          python3 sustainability_evaluator.py --path . --format json --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" || true
          
          if [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" "${{ env.REPORT_PATH }}/latest-report.html"
          fi
          
          if [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" "${{ env.REPORT_PATH }}/latest-report.json"
            SCORE=$(python3 -c "import json; data=json.load(open('${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json')); print(data.get('overall_score', 75))" 2>/dev/null || echo "75")
          else
            SCORE="75"
          fi
          
          echo "overall_score=$SCORE" >> $GITHUB_OUTPUT
          echo "Analysis completed - Score: $SCORE/100"
        else
          echo "sustainability_evaluator.py not found"
          exit 1
        fi
        
    - name: ğŸ—ï¸ Setup GitHub Pages
      uses: actions/configure-pages@v5
      if: github.ref == 'refs/heads/main'
      
    - name: ğŸŒ Create Dashboard
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p pages
        cp -r ${{ env.REPORT_PATH }}/* pages/ 2>/dev/null || true
        
        echo '<!DOCTYPE html>' > pages/index.html
        echo '<html>' >> pages/index.html
        echo '<head>' >> pages/index.html
        echo '    <title>ğŸŒ± Sustainability Dashboard</title>' >> pages/index.html
        echo '    <style>' >> pages/index.html
        echo '        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }' >> pages/index.html
        echo '        .header { background: #198754; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }' >> pages/index.html
        echo '        .btn { background: #198754; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; }' >> pages/index.html
        echo '    </style>' >> pages/index.html
        echo '</head>' >> pages/index.html
        echo '<body>' >> pages/index.html
        echo '    <div class="header">' >> pages/index.html
        echo '        <h1>ğŸŒ± Sustainability Dashboard</h1>' >> pages/index.html
        echo '        <p>Green Coding Analysis Reports</p>' >> pages/index.html
        echo '    </div>' >> pages/index.html
        echo '    <p><a href="latest-report.html" class="btn">ğŸ“Š View Latest Report</a></p>' >> pages/index.html
        echo '</body>' >> pages/index.html
        echo '</html>' >> pages/index.html
        
    - name: ğŸš€ Deploy to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      if: github.ref == 'refs/heads/main'
      with:
        path: pages/
        
    - name: ğŸŒ Publish GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      if: github.ref == 'refs/heads/main'
      
    - name: ğŸ“¤ Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: sustainability-reports-${{ github.sha }}
        path: ${{ env.REPORT_PATH }}/*
        retention-days: 30
        
    - name: ğŸ“ Commit Reports
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ${{ env.REPORT_PATH }}/
        
        if ! git diff --staged --quiet; then
          git commit -m "Auto-generated sustainability reports"
          git push
        fi
        
    - name: ğŸ’¬ PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        SCORE: ${{ steps.analysis.outputs.overall_score }}
      with:
        script: |
          const score = process.env.SCORE || '75';
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸŒ± **Sustainability Analysis Complete** - Score: ${score}/100`
          });
