name: üå± Enhanced Sustainability Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  schedule:
    # Weekly comprehensive analysis on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      analysis_depth:
        description: 'Analysis depth'
        required: false
        default: 'comprehensive'
        type: choice
        options:
        - quick
        - standard  
        - comprehensive
      generate_trends:
        description: 'Generate trend analysis'
        required: false
        default: true
        type: boolean
      deploy_dashboard:
        description: 'Deploy to GitHub Pages'
        required: false
        default: true
        type: boolean

# Prevent concurrent runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  REPORT_PATH: 'sustainability-reports'
  CACHE_VERSION: 'v1'
  MIN_SUSTAINABILITY_SCORE: 60
  NOTIFICATION_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # ==========================================
  # Pre-Analysis: Environment Setup & Validation  
  # ==========================================
  setup-and-validate:
    name: üîß Setup & Validate Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should-analyze: ${{ steps.changes.outputs.code-changed }}
      analysis-depth: ${{ steps.config.outputs.depth }}
      project-languages: ${{ steps.detect.outputs.languages }}
      file-count: ${{ steps.detect.outputs.file-count }}
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for trend analysis
        
    - name: üîç Detect Changed Files
      uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          code-changed:
            - 'backend/**/*.{js,ts,py}'
            - 'frontend/**/*.{js,ts,jsx,tsx}'
            - '*.{js,ts,py}'
            - 'package.json'
            - 'requirements.txt'
            - 'pyproject.toml'
            
    - name: ‚öôÔ∏è Configure Analysis
      id: config
      run: |
        DEPTH="${{ inputs.analysis_depth || 'standard' }}"
        if [[ "${{ github.event_name }}" == "schedule" ]]; then
          DEPTH="comprehensive"
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          DEPTH="quick"
        fi
        echo "depth=$DEPTH" >> $GITHUB_OUTPUT
        echo "üéØ Analysis depth set to: $DEPTH"
        
    - name: üîç Detect Project Languages & Structure
      id: detect
      run: |
        # Count source files
        FILE_COUNT=$(find . -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | grep -v node_modules | grep -v .venv | wc -l)
        
        # Detect primary languages
        LANGUAGES=""
        if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || find . -name "*.py" -not -path "./node_modules/*" -not -path "./.venv/*" | head -1 | grep -q .; then
          LANGUAGES="$LANGUAGES python"
        fi
        if [ -f "package.json" ] || find . -name "*.js" -o -name "*.ts" -not -path "./node_modules/*" | head -1 | grep -q .; then
          LANGUAGES="$LANGUAGES javascript"
        fi
        
        echo "file-count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "languages=$(echo $LANGUAGES | tr ' ' ',')" >> $GITHUB_OUTPUT
        echo "üìä Detected $FILE_COUNT source files"
        echo "üó£Ô∏è Languages: $LANGUAGES"

  # ==========================================
  # Core Analysis: Multi-Language Sustainability Analysis
  # ==========================================
  sustainability-analysis:
    name: üå± Sustainability Analysis
    runs-on: ubuntu-latest
    needs: setup-and-validate
    if: needs.setup-and-validate.outputs.should-analyze == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    timeout-minutes: 20
    environment:
      name: sustainability-analysis
      url: ${{ steps.deployment.outputs.page_url }}
    
    strategy:
      matrix:
        analysis-type: 
          - sustainability
          - security
          - performance
          - dependencies
    
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
      deployments: write
      pull-requests: write
      security-events: write
      checks: write
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: üêç Setup Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: üü¢ Setup Node.js Environment  
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          frontend/package-lock.json
          
    - name: üì¶ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        
        # Core analysis tools
        pip install radon>=6.0.1 xenon>=0.9.0 bandit>=1.7.5 safety>=2.3.0 
        pip install pylint>=3.0.0 flake8>=6.0.0 mypy>=1.0.0 black>=23.0.0
        
        # Advanced analysis tools  
        pip install vulture>=2.7 mccabe>=0.7.0 pyflakes>=3.0.0 
        pip install prospector>=1.10.0 pydocstyle>=6.3.0
        
        # Sustainability-specific tools
        pip install psutil>=5.9.0 requests>=2.31.0 
        pip install flask>=2.3.0 flask-cors>=4.0.0
        
        # Optional: Code quality metrics
        pip install lizard>=1.17.10 || echo "‚ö†Ô∏è lizard not available"
        
    - name: üì¶ Install Node.js Dependencies
      if: contains(needs.setup-and-validate.outputs.project-languages, 'javascript')
      run: |
        # Install frontend dependencies if package.json exists
        if [ -f "package.json" ]; then
          npm ci --production=false
        fi
        
        if [ -f "frontend/package.json" ]; then
          cd frontend && npm ci --production=false && cd ..
        fi
        
        # Install analysis tools globally
        npm install -g eslint@latest jshint@latest
        npm install -g webpack-bundle-analyzer@latest || echo "‚ö†Ô∏è webpack-bundle-analyzer not available"
        
    - name: üõ°Ô∏è Security Analysis
      if: matrix.analysis-type == 'security'
      run: |
        mkdir -p ${{ env.REPORT_PATH }}/security
        
        # Python security analysis
        if command -v bandit &> /dev/null && find . -name "*.py" -not -path "./node_modules/*" -not -path "./.venv/*" | head -1 | grep -q .; then
          echo "üîí Running Python security analysis..."
          bandit -r . -f json -o ${{ env.REPORT_PATH }}/security/bandit-report.json --exclude .venv,node_modules || true
          bandit -r . -f txt -o ${{ env.REPORT_PATH }}/security/bandit-report.txt --exclude .venv,node_modules || true
        fi
        
        # Dependency vulnerability check
        if [ -f "requirements.txt" ]; then
          echo "üîç Checking Python dependencies for vulnerabilities..."
          safety check --json --output ${{ env.REPORT_PATH }}/security/safety-report.json || true
        fi
        
        # JavaScript security analysis (if available)
        if [ -f "package.json" ] && command -v npm &> /dev/null; then
          echo "üîí Running Node.js security analysis..."
          npm audit --json > ${{ env.REPORT_PATH }}/security/npm-audit.json 2>/dev/null || true
        fi
        
    - name: ‚ö° Performance Analysis
      if: matrix.analysis-type == 'performance'
      run: |
        mkdir -p ${{ env.REPORT_PATH }}/performance
        
        # Python complexity analysis
        if find . -name "*.py" -not -path "./node_modules/*" -not -path "./.venv/*" | head -1 | grep -q .; then
          echo "üìä Analyzing Python code complexity..."
          radon cc . --json --exclude "*.venv*,*node_modules*" > ${{ env.REPORT_PATH }}/performance/radon-complexity.json || true
          radon mi . --json --exclude "*.venv*,*node_modules*" > ${{ env.REPORT_PATH }}/performance/radon-maintainability.json || true
          xenon --max-absolute B --max-modules B --max-average A . --exclude "*.venv*,*node_modules*" || true
        fi
        
        # JavaScript/TypeScript analysis
        if find . -name "*.js" -o -name "*.ts" -not -path "./node_modules/*" | head -1 | grep -q .; then
          echo "üìä Analyzing JavaScript code quality..."
          if command -v eslint &> /dev/null; then
            eslint . --ext .js,.ts,.jsx,.tsx --format json --output-file ${{ env.REPORT_PATH }}/performance/eslint-report.json || true
          fi
        fi
        
        # Bundle size analysis (if webpack config exists)
        if [ -f "webpack.config.js" ] && command -v webpack-bundle-analyzer &> /dev/null; then
          echo "üì¶ Analyzing bundle size..."
          npm run build --if-present || echo "‚ö†Ô∏è Build failed, skipping bundle analysis"
        fi
        
    - name: üìä Dependency Analysis
      if: matrix.analysis-type == 'dependencies'
      run: |
        mkdir -p ${{ env.REPORT_PATH }}/dependencies
        
        # Python dependency analysis
        if [ -f "requirements.txt" ]; then
          echo "üì¶ Analyzing Python dependencies..."
          pip list --format=json > ${{ env.REPORT_PATH }}/dependencies/python-packages.json
          pip-licenses --format=json --output-file=${{ env.REPORT_PATH }}/dependencies/python-licenses.json 2>/dev/null || echo "‚ö†Ô∏è pip-licenses not available"
        fi
        
        # Node.js dependency analysis  
        if [ -f "package.json" ]; then
          echo "üì¶ Analyzing Node.js dependencies..."
          npm ls --json > ${{ env.REPORT_PATH }}/dependencies/npm-packages.json 2>/dev/null || true
          npm outdated --json > ${{ env.REPORT_PATH }}/dependencies/npm-outdated.json 2>/dev/null || true
        fi
        
        # Generate dependency tree
        echo "üå≥ Generating dependency overview..."
        echo "{" > ${{ env.REPORT_PATH }}/dependencies/summary.json
        echo '  "python_packages": '$([ -f "${{ env.REPORT_PATH }}/dependencies/python-packages.json" ] && cat ${{ env.REPORT_PATH }}/dependencies/python-packages.json | jq length || echo 0)',' >> ${{ env.REPORT_PATH }}/dependencies/summary.json
        echo '  "node_packages": '$([ -f "${{ env.REPORT_PATH }}/dependencies/npm-packages.json" ] && echo 0 || echo 0)',' >> ${{ env.REPORT_PATH }}/dependencies/summary.json  
        echo '  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"' >> ${{ env.REPORT_PATH }}/dependencies/summary.json
        echo "}" >> ${{ env.REPORT_PATH }}/dependencies/summary.json
        
    - name: üå± Core Sustainability Analysis
      if: matrix.analysis-type == 'sustainability'
      id: sustainability
      run: |
        mkdir -p ${{ env.REPORT_PATH }}
        
        # Determine analysis parameters based on depth
        ANALYSIS_DEPTH="${{ needs.setup-and-validate.outputs.analysis-depth }}"
        
        if [ "$ANALYSIS_DEPTH" = "quick" ]; then
          ANALYSIS_ARGS="--quick --max-files 50"
        elif [ "$ANALYSIS_DEPTH" = "comprehensive" ]; then
          ANALYSIS_ARGS="--comprehensive --include-trends"
        else
          ANALYSIS_ARGS=""
        fi
        
        echo "üå± Running sustainability analysis (depth: $ANALYSIS_DEPTH)..."
        
        if [ -f "sustainability_evaluator.py" ]; then
          chmod +x sustainability_evaluator.py
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OUTPUT_BASE="report-${TIMESTAMP}"
          
          # Run analysis with error handling
          python3 sustainability_evaluator.py \
            --path . \
            --format both \
            --output "${{ env.REPORT_PATH }}/${OUTPUT_BASE}" \
            $ANALYSIS_ARGS || echo "‚ö†Ô∏è Analysis completed with warnings"
          
          # Copy to latest files
          if [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.html" "${{ env.REPORT_PATH }}/latest-report.html"
          fi
          
          if [ -f "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" ]; then
            cp "${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json" "${{ env.REPORT_PATH }}/latest-report.json"
            
            # Extract key metrics
            SCORE=$(python3 -c 'import json; f=open("${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json"); data=json.load(f); print(f"{data.get(\"sustainability_metrics\", {}).get(\"overall_score\", 50):.1f}")' 2>/dev/null || echo "50.0")
            
            ENERGY_SCORE=$(python3 -c 'import json; f=open("${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json"); data=json.load(f); print(f"{data.get(\"sustainability_metrics\", {}).get(\"energy_efficiency\", 50):.1f}")' 2>/dev/null || echo "50.0")
            
            RECOMMENDATIONS=$(python3 -c 'import json; f=open("${{ env.REPORT_PATH }}/${OUTPUT_BASE}.json"); data=json.load(f); print(len(data.get("recommendations", [])))' 2>/dev/null || echo "0")
            
            # Set outputs
            echo "overall_score=$SCORE" >> $GITHUB_OUTPUT
            echo "energy_efficiency=$ENERGY_SCORE" >> $GITHUB_OUTPUT
            echo "recommendations_count=$RECOMMENDATIONS" >> $GITHUB_OUTPUT
            echo "report_generated=true" >> $GITHUB_OUTPUT
            
            echo "üìä Analysis Results:"
            echo "   ‚Ä¢ Overall Score: $SCORE/100"
            echo "   ‚Ä¢ Energy Efficiency: $ENERGY_SCORE/100" 
            echo "   ‚Ä¢ Recommendations: $RECOMMENDATIONS"
            
            # Quality gate check
            if (( $(echo "$SCORE < $MIN_SUSTAINABILITY_SCORE" | bc -l) )); then
              echo "‚ùå Sustainability score ($SCORE) below minimum threshold ($MIN_SUSTAINABILITY_SCORE)"
              echo "quality_gate_passed=false" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Sustainability score meets quality gate"
              echo "quality_gate_passed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Analysis failed to generate JSON report"
            echo "overall_score=0" >> $GITHUB_OUTPUT
            echo "report_generated=false" >> $GITHUB_OUTPUT
            echo "quality_gate_passed=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "‚ùå sustainability_evaluator.py not found"
          exit 1
        fi
        
    - name: üìà Generate Trend Analysis
      if: matrix.analysis-type == 'sustainability' && (github.event_name == 'schedule' || inputs.generate_trends == 'true')
      run: |
        echo "üìà Generating sustainability trends..."
        
        # Collect historical data from previous reports
        mkdir -p ${{ env.REPORT_PATH }}/trends
        
        # Count available reports for trend analysis
        REPORT_COUNT=$(ls -1 ${{ env.REPORT_PATH }}/report-*.json 2>/dev/null | wc -l)
        echo "Found $REPORT_COUNT historical reports for trend analysis"
        
        # Create basic trend metadata
        echo "{" > ${{ env.REPORT_PATH }}/trends/analysis.json
        echo '  "reports_analyzed": '$REPORT_COUNT',' >> ${{ env.REPORT_PATH }}/trends/analysis.json
        echo '  "generated_at": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",' >> ${{ env.REPORT_PATH }}/trends/analysis.json
        echo '  "trend_period_days": 30,' >> ${{ env.REPORT_PATH }}/trends/analysis.json
        echo '  "message": "Basic trend tracking - detailed analysis requires 2+ reports"' >> ${{ env.REPORT_PATH }}/trends/analysis.json
        echo "}" >> ${{ env.REPORT_PATH }}/trends/analysis.json
        
        echo "üìà Trend analysis complete: $REPORT_COUNT reports tracked"
        
    - name: üì§ Upload Analysis Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sustainability-analysis-${{ matrix.analysis-type }}-${{ github.sha }}
        path: ${{ env.REPORT_PATH }}/**/*
        retention-days: 90
        compression-level: 6
        
    - name: üìä Create Analysis Summary
      if: matrix.analysis-type == 'sustainability'
      id: summary
      run: |
        # Generate summary for other jobs
        cat << EOF > analysis-summary.json
        {
          "overall_score": "${{ steps.sustainability.outputs.overall_score }}",
          "energy_efficiency": "${{ steps.sustainability.outputs.energy_efficiency }}",
          "recommendations": "${{ steps.sustainability.outputs.recommendations_count }}",
          "quality_gate": "${{ steps.sustainability.outputs.quality_gate_passed }}",
          "file_count": "${{ needs.setup-and-validate.outputs.file-count }}",
          "languages": "${{ needs.setup-and-validate.outputs.project-languages }}",
          "analysis_depth": "${{ needs.setup-and-validate.outputs.analysis-depth }}"
        }
        EOF
        
        echo "summary-created=true" >> $GITHUB_OUTPUT

  # ==========================================  
  # Deployment: GitHub Pages & Notifications
  # ==========================================
  deploy-dashboard:
    name: üöÄ Deploy Dashboard  
    runs-on: ubuntu-latest
    needs: [setup-and-validate, sustainability-analysis]
    if: (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && (inputs.deploy_dashboard != 'false')
    timeout-minutes: 10
    
    environment:
      name: github-pages  
      url: ${{ steps.deployment.outputs.page_url }}
      
    permissions:
      contents: read
      pages: write
      id-token: write
      
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üìä Download Analysis Results  
      uses: actions/download-artifact@v4
      with:
        pattern: sustainability-analysis-*
        merge-multiple: true
        path: ${{ env.REPORT_PATH }}
        
    - name: üèóÔ∏è Setup GitHub Pages
      uses: actions/configure-pages@v5
      
    - name: üåê Create Enhanced Dashboard
      run: |
        mkdir -p pages
        
        # Copy all analysis results
        cp -r ${{ env.REPORT_PATH }}/* pages/ 2>/dev/null || true
        
        # Create enhanced index page with analysis overview
        cat << 'EOF' > pages/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>üå± Enhanced Sustainability Dashboard</title>
            <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå±</text></svg>">
            <style>
                :root {
                  --primary-green: #27ae60;
                  --secondary-green: #2ecc71; 
                  --accent-blue: #3498db;
                  --warning-orange: #f39c12;
                  --danger-red: #e74c3c;
                  --dark-bg: #2c3e50;
                  --light-bg: #ecf0f1;
                }
                
                * { margin: 0; padding: 0; box-sizing: border-box; }
                
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, var(--primary-green) 75%, var(--secondary-green) 100%);
                    min-height: 100vh; color: white; line-height: 1.6;
                }
                
                .header {
                    background: linear-gradient(135deg, var(--dark-bg) 0%, #34495e 100%);
                    padding: 3rem 2rem; text-align: center;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                }
                
                .header h1 { 
                    font-size: 3.5rem; margin-bottom: 1rem;
                    background: linear-gradient(45deg, #fff, #e0e0e0);
                    -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
                    background-clip: text; text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                }
                
                .subtitle { font-size: 1.3rem; opacity: 0.9; margin-bottom: 2rem; }
                
                .dashboard-container { 
                    max-width: 1400px; margin: 0 auto; padding: 2rem;
                }
                
                .metrics-grid {
                    display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                    gap: 2rem; margin: 2rem 0;
                }
                
                .metric-card {
                    background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);
                    border-radius: 20px; padding: 2rem; text-align: center;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    transition: all 0.3s ease;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }
                
                .metric-card:hover { 
                    transform: translateY(-5px); 
                    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
                    background: rgba(255, 255, 255, 0.2);
                }
                
                .metric-value { 
                    font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;
                    color: var(--secondary-green);
                }
                
                .metric-label { font-size: 1.1rem; opacity: 0.9; }
                
                .dashboard-btn {
                    display: inline-block; 
                    background: linear-gradient(45deg, var(--primary-green), var(--secondary-green));
                    color: white; padding: 1.2rem 2.5rem; text-decoration: none; 
                    border-radius: 50px; font-weight: 600; font-size: 1.2rem; 
                    transition: all 0.3s ease; margin: 1rem 0.5rem;
                    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
                }
                
                .dashboard-btn:hover { 
                    transform: translateY(-2px); 
                    box-shadow: 0 8px 25px rgba(39, 174, 96, 0.6);
                }
                
                .dashboard-btn.secondary {
                    background: linear-gradient(45deg, var(--accent-blue), #5dade2);
                    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
                }
                
                .dashboard-btn.secondary:hover {
                    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.6);
                }
                
                .features {
                    display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 1.5rem; margin: 3rem 0;
                }
                
                .feature { 
                    background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);
                    padding: 1.5rem; border-radius: 15px;
                    transition: all 0.3s ease;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .feature:hover { 
                    transform: translateY(-3px); 
                    background: rgba(255, 255, 255, 0.15);
                    border-color: rgba(255, 255, 255, 0.3);
                }
                
                .feature h3 { margin-bottom: 1rem; color: var(--secondary-green); }
                
                .status-indicator {
                    display: inline-block; width: 12px; height: 12px;
                    border-radius: 50%; margin-right: 8px;
                }
                
                .status-good { background: var(--secondary-green); }
                .status-warning { background: var(--warning-orange); }  
                .status-danger { background: var(--danger-red); }
                
                .footer {
                    background: var(--dark-bg); padding: 2rem;
                    text-align: center; margin-top: 3rem;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                @media (max-width: 768px) {
                    .header h1 { font-size: 2.5rem; }
                    .dashboard-container { padding: 1rem; }
                    .metrics-grid { grid-template-columns: 1fr; gap: 1rem; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üå± Enhanced Sustainability Dashboard</h1>
                <p class="subtitle">Comprehensive Code Analysis & Environmental Impact Tracking</p>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">{{ OVERALL_SCORE | default: "75" }}/100</div>
                        <div class="metric-label">
                            <span class="status-indicator status-{{ SCORE_STATUS | default: 'warning' }}"></span>
                            Overall Sustainability
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ ENERGY_SCORE | default: "68" }}/100</div>
                        <div class="metric-label">Energy Efficiency</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ RECOMMENDATIONS | default: "4" }}</div>
                        <div class="metric-label">Active Recommendations</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ FILE_COUNT | default: "25" }}</div>
                        <div class="metric-label">Files Analyzed</div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-container">
                <div style="text-align: center; margin: 2rem 0;">
                    <a href="latest-report.html" class="dashboard-btn">
                        üìä View Detailed Report
                    </a>
                    <a href="trends/analysis.json" class="dashboard-btn secondary">
                        üìà Trend Analysis
                    </a>
                    <a href="security/" class="dashboard-btn secondary">
                        üîí Security Reports
                    </a>
                </div>
                
                <div class="features">
                    <div class="feature">
                        <h3>üåç Carbon Impact</h3>
                        <p>Track CO‚ÇÇ emissions, energy usage patterns, and environmental sustainability metrics across your entire codebase.</p>
                    </div>
                    <div class="feature">
                        <h3>‚ö° Performance Analytics</h3>
                        <p>Monitor code efficiency, execution speed, memory usage, and optimization opportunities with interactive visualizations.</p>
                    </div>
                    <div class="feature">
                        <h3>üìä Multi-Language Support</h3>
                        <p>Comprehensive analysis for Python, JavaScript, TypeScript, and more with language-specific optimization recommendations.</p>
                    </div>
                    <div class="feature">
                        <h3>üîí Security Integration</h3>
                        <p>Combined sustainability and security analysis with vulnerability detection and dependency scanning.</p>
                    </div>
                    <div class="feature">
                        <h3>üöÄ CI/CD Integration</h3>
                        <p>Automated analysis in pull requests with quality gates, trend tracking, and deployment integration.</p>
                    </div>
                    <div class="feature">
                        <h3>üìà Historical Trends</h3>
                        <p>Track improvements over time with comprehensive trend analysis and performance benchmarking.</p>
                    </div>
                </div>
                
                <div class="footer">
                    <p>ü§ñ Auto-generated by Enhanced Sustainability Pipeline</p>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;">
                        Last updated: {{ LAST_UPDATED | default: "Recently" }} ‚Ä¢ 
                        Next scan: {{ NEXT_SCAN | default: "Scheduled" }}
                    </p>
                </div>
            </div>
        </body>
        </html>
        EOF
        
        echo "üåê Enhanced dashboard created successfully"
        
    - name: üöÄ Deploy to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: pages/
        
    - name: üåê Publish Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # ==========================================
  # Quality Gates & Notifications
  # ==========================================  
  quality-gates:
    name: üö® Quality Gates & Notifications
    runs-on: ubuntu-latest
    needs: [setup-and-validate, sustainability-analysis]
    if: always() && needs.sustainability-analysis.result != 'skipped'
    timeout-minutes: 5
    
    steps:
    - name: üìä Evaluate Quality Gates  
      id: gates
      run: |
        SCORE="${{ needs.sustainability-analysis.outputs.overall_score || '0' }}"
        QUALITY_PASSED="${{ needs.sustainability-analysis.outputs.quality_gate_passed || 'false' }}"
        
        echo "üéØ Quality Gate Evaluation:"
        echo "   ‚Ä¢ Sustainability Score: $SCORE/100"
        echo "   ‚Ä¢ Minimum Required: ${{ env.MIN_SUSTAINABILITY_SCORE }}/100"
        echo "   ‚Ä¢ Status: $([ "$QUALITY_PASSED" = "true" ] && echo "‚úÖ PASSED" || echo "‚ùå FAILED")"
        
        # Set status for other steps
        echo "score=$SCORE" >> $GITHUB_OUTPUT
        echo "passed=$QUALITY_PASSED" >> $GITHUB_OUTPUT
        
        # Generate status message
        if [ "$QUALITY_PASSED" = "true" ]; then
          echo "status=‚úÖ Quality gates passed - Sustainability score: $SCORE/100" >> $GITHUB_OUTPUT
        else
          echo "status=‚ùå Quality gates failed - Sustainability score: $SCORE/100 (minimum: ${{ env.MIN_SUSTAINABILITY_SCORE }})" >> $GITHUB_OUTPUT
        fi
        
    - name: üí¨ PR Comment with Detailed Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        SCORE: ${{ steps.gates.outputs.score }}
        STATUS: ${{ steps.gates.outputs.status }}
        RECOMMENDATIONS: ${{ needs.sustainability-analysis.outputs.recommendations_count }}
        ENERGY_EFFICIENCY: ${{ needs.sustainability-analysis.outputs.energy_efficiency }}
      with:
        script: |
          const score = process.env.SCORE || '0';
          const status = process.env.STATUS || 'Analysis incomplete';
          const recommendations = process.env.RECOMMENDATIONS || '0';
          const energy = process.env.ENERGY_EFFICIENCY || '0';
          
          const scoreEmoji = score >= 80 ? 'üü¢' : score >= 60 ? 'üü°' : 'üî¥';
          const energyEmoji = energy >= 70 ? '‚ö°' : energy >= 50 ? 'üîã' : 'ü™´';
          
          const body = `## üå± Sustainability Analysis Results
          
          ${status}
          
          ### üìä Key Metrics
          | Metric | Score | Status |
          |--------|--------|--------|
          | ${scoreEmoji} Overall Sustainability | **${score}/100** | ${score >= 60 ? 'PASS' : 'FAIL'} |
          | ${energyEmoji} Energy Efficiency | **${energy}/100** | ${energy >= 50 ? 'GOOD' : 'NEEDS WORK'} |
          | üí° Recommendations | **${recommendations}** | ${recommendations <= 5 ? 'MANAGEABLE' : 'HIGH'} |
          
          ### üéØ Next Steps
          ${recommendations > 0 ? `- Review and address **${recommendations}** sustainability recommendations` : '- ‚úÖ No critical sustainability issues found'}
          ${score < 60 ? '- Focus on improving overall sustainability score above 60/100' : ''}
          ${energy < 50 ? '- Prioritize energy efficiency improvements' : ''}
          
          ### üìà View Reports
          - üìä [Detailed Analysis Report](../../../actions/runs/${{ github.run_id }})
          - üåê [Live Dashboard](https://cog-meenss.github.io/sustainability-tracker/)
          
          ---
          *ü§ñ Generated by Enhanced Sustainability Pipeline ‚Ä¢ [View Workflow](../../../actions/workflows/enhanced-sustainability-pipeline.yml)*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
          
    - name: üîç Create Check Run
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        SCORE: ${{ steps.gates.outputs.score }}
        PASSED: ${{ steps.gates.outputs.passed }}
      with:
        script: |
          const score = process.env.SCORE;
          const passed = process.env.PASSED === 'true';
          
          await github.rest.checks.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            name: 'Sustainability Quality Gate',
            head_sha: context.payload.pull_request.head.sha,
            status: 'completed',
            conclusion: passed ? 'success' : 'failure',
            output: {
              title: passed ? '‚úÖ Sustainability Check Passed' : '‚ùå Sustainability Check Failed',
              summary: `Sustainability score: ${score}/100 (minimum: ${{ env.MIN_SUSTAINABILITY_SCORE }})`,
              text: passed 
                ? `üéâ Great job! Your code meets the sustainability requirements with a score of ${score}/100.`
                : `üîß Your code scored ${score}/100, which is below the minimum requirement of ${{ env.MIN_SUSTAINABILITY_SCORE }}/100. Please review the sustainability recommendations and optimize your code.`
            }
          });
          
    - name: üì¢ Slack Notification
      if: env.NOTIFICATION_WEBHOOK != '' && (github.ref == 'refs/heads/main' || steps.gates.outputs.passed == 'false')
      uses: 8398a7/action-slack@v3
      env:
        SLACK_WEBHOOK_URL: ${{ env.NOTIFICATION_WEBHOOK }}
      with:
        status: custom
        custom_payload: |
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üå± Sustainability Analysis Complete"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": `*Repository:* ${{ github.repository }}`
                  },
                  {
                    "type": "mrkdwn", 
                    "text": `*Branch:* ${{ github.ref_name }}`
                  },
                  {
                    "type": "mrkdwn",
                    "text": `*Score:* ${{ steps.gates.outputs.score }}/100`
                  },
                  {
                    "type": "mrkdwn",
                    "text": `*Status:* ${{ steps.gates.outputs.passed == 'true' && '‚úÖ PASSED' || '‚ùå FAILED' }}`
                  }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üìä View Dashboard"
                    },
                    "url": "https://cog-meenss.github.io/sustainability-tracker/"
                  },
                  {
                    "type": "button", 
                    "text": {
                      "type": "plain_text",
                      "text": "üîç View Details"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }

  # ==========================================
  # Cleanup & Maintenance
  # ==========================================
  cleanup:
    name: üßπ Cleanup & Maintenance
    runs-on: ubuntu-latest
    needs: [deploy-dashboard, quality-gates]
    if: always() && github.ref == 'refs/heads/main'
    timeout-minutes: 5
    
    permissions:
      contents: write
      
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üóÇÔ∏è Archive Old Reports
      run: |
        # Keep only last 30 reports to prevent repository bloat
        cd ${{ env.REPORT_PATH }}
        ls -t report-*.json 2>/dev/null | tail -n +31 | xargs rm -f || echo "No old reports to clean"
        ls -t report-*.html 2>/dev/null | tail -n +31 | xargs rm -f || echo "No old HTML reports to clean"
        
        echo "üìä Report cleanup complete"
        
    - name: üìù Commit Cleanup Changes
      if: ${{ !contains(github.event.head_commit.message, 'Auto-generated sustainability reports') }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Cleanup"
        
        git add ${{ env.REPORT_PATH }}/
        
        if ! git diff --staged --quiet; then
          git commit -m "üßπ Cleanup old sustainability reports [skip ci]"
          git push
        else
          echo "No cleanup changes to commit"
        fi