trigger:
- main
- develop
- feature/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  CARBON_THRESHOLD: '0.1'  # Maximum allowed kg CO2
  PYTHON_VERSION: '3.9'

stages:
- stage: CarbonFootprintAnalysis
  displayName: 'Carbon Footprint Analysis'
  jobs:
  - job: AnalyzeProject
    displayName: 'Analyze Project Carbon Footprint'
    
    steps:
    - checkout: self
      fetchDepth: 0
      
    - task: UsePythonVersion@0
      displayName: 'Set up Python $(PYTHON_VERSION)'
      inputs:
        versionSpec: '$(PYTHON_VERSION)'
        
    - script: |
        echo "üå± Setting up Carbon Footprint Analysis Environment"
        python -m pip install --upgrade pip
        pip install requests pandas numpy
        
        echo "üìÇ Project Structure:"
        find . -name "*.js" -o -name "*.py" -o -name "*.java" | head -20
        
        echo "üîç Carbon Analyzer Setup:"
        cd carbon-footprint-analyzer
        ls -la src/
      displayName: 'Setup Environment'

    - script: |
        echo "üå± STARTING CARBON FOOTPRINT ANALYSIS"
        echo "=================================="
        
        cd carbon-footprint-analyzer
        
        # Run the carbon analysis
        echo "üîç Analyzing project carbon footprint..."
        python cli.py .. --format json html --output ../carbon-reports --config examples/configs/web_app_config.json
        
        echo ""
        echo "üìä ANALYSIS RESULTS:"
        echo "==================="
        
        # Display key metrics from JSON report
        if [ -f "../carbon-reports/complete_analysis.json" ]; then
          echo "‚úÖ Analysis completed successfully!"
          
          # Extract key metrics using Python
          python3 -c "
import json
import sys
import os

try:
    with open('../carbon-reports/complete_analysis.json', 'r') as f:
        data = json.load(f)
    
    # Extract metrics
    lang_analysis = data.get('language_analysis', {})
    carbon_data = data.get('carbon_footprint', {})
    
    primary_lang = lang_analysis.get('primary_language', 'Unknown')
    total_files = lang_analysis.get('total_files', 0)
    carbon_kg = carbon_data.get('total_carbon_kg', 0)
    energy_kwh = carbon_data.get('total_energy_kwh', 0)
    impact_level = carbon_data.get('comparison_metrics', {}).get('impact_level', 'unknown')
    
    print('üéØ PROJECT SUMMARY:')
    print(f'   Primary Language: {primary_lang}')
    print(f'   Files Analyzed: {total_files}')
    print(f'   Carbon Footprint: {carbon_kg:.6f} kg CO2')
    print(f'   Energy Consumption: {energy_kwh:.6f} kWh')
    print(f'   Impact Level: {impact_level.upper()}')
    print('')
    
    # Check threshold
    threshold = float(os.environ.get('CARBON_THRESHOLD', '0.1'))
    print(f'üéØ THRESHOLD CHECK:')
    print(f'   Current: {carbon_kg:.6f} kg CO2')
    print(f'   Threshold: {threshold} kg CO2')
    
    if carbon_kg > threshold:
        print(f'   Status: ‚ö†Ô∏è  EXCEEDS THRESHOLD')
        sys.exit(2)  # Warning status
    else:
        print(f'   Status: ‚úÖ WITHIN THRESHOLD')
    
    # Show breakdown if available
    components = carbon_data.get('components', {})
    if components:
        print('')
        print('üìä CARBON BREAKDOWN:')
        for component, details in components.items():
            if isinstance(details, dict) and 'percentage' in details:
                percentage = details.get('percentage', 0)
                if percentage > 0:
                    print(f'   {component.replace(\"_\", \" \").title()}: {percentage:.1f}%')
    
    # Show top recommendations
    recommendations = data.get('optimization_recommendations', [])
    if recommendations:
        print('')
        print('üí° TOP OPTIMIZATION RECOMMENDATIONS:')
        for i, rec in enumerate(recommendations[:3], 1):
            print(f'   {i}. {rec}')
    
    print('')
    print('üåç ENVIRONMENTAL CONTEXT:')
    comparisons = carbon_data.get('comparison_metrics', {}).get('comparisons', {})
    if comparisons:
        smartphone = comparisons.get('smartphone_charging', {})
        if smartphone:
            print(f'   Equivalent to {smartphone.get(\"value\", 0):.1f} smartphone charges')
        
        car = comparisons.get('car_distance', {})
        if car:
            print(f'   Equivalent to {car.get(\"value\", 0):.3f} km by car')

except Exception as e:
    print(f'‚ùå Error reading analysis results: {e}')
    sys.exit(1)
"
        else
          echo "‚ùå Analysis failed - no results file found"
          exit 1
        fi
        
      displayName: 'Run Carbon Analysis'
      continueOnError: true
      
    - script: |
        echo "üìÑ GENERATING RUNTIME REPORT DISPLAY"
        echo "====================================="
        
        cd carbon-footprint-analyzer
        
        # Create a runtime display script
        cat > ../show_runtime_report.py << 'EOF'
import json
import os
from datetime import datetime

def create_runtime_display():
    """Create an enhanced runtime display of carbon analysis results"""
    
    print("\n" + "="*80)
    print("üå± CARBON FOOTPRINT ANALYSIS - RUNTIME REPORT")
    print("="*80)
    print(f"üìÖ Analysis Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"üîç Pipeline: Azure DevOps")
    print("="*80)
    
    try:
        # Load analysis results
        with open('carbon-reports/complete_analysis.json', 'r') as f:
            data = json.load(f)
        
        # Project Overview
        project_overview = data.get('project_overview', {})
        lang_analysis = data.get('language_analysis', {})
        carbon_data = data.get('carbon_footprint', {})
        
        print("\nüìä PROJECT OVERVIEW:")
        print("-" * 40)
        print(f"Project Name: {project_overview.get('name', 'Unknown')}")
        print(f"Primary Language: {lang_analysis.get('primary_language', 'Unknown')}")
        print(f"Total Files: {lang_analysis.get('total_files', 0)}")
        print(f"Project Type: {lang_analysis.get('project_type', 'Unknown')}")
        
        # Language Distribution
        lang_dist = lang_analysis.get('language_distribution', {})
        if lang_dist:
            print(f"\nüó£Ô∏è LANGUAGE DISTRIBUTION:")
            print("-" * 40)
            for lang, percentage in sorted(lang_dist.items(), key=lambda x: x[1], reverse=True):
                print(f"{lang.ljust(15)}: {percentage:6.1f}%")
        
        # Carbon Metrics
        print(f"\nüå± CARBON FOOTPRINT METRICS:")
        print("-" * 40)
        print(f"Total Emissions: {carbon_data.get('total_carbon_kg', 0):.6f} kg CO2")
        print(f"Energy Usage:    {carbon_data.get('total_energy_kwh', 0):.6f} kWh")
        print(f"Grid Type:       {carbon_data.get('grid_type', 'Unknown')}")
        print(f"Impact Level:    {carbon_data.get('comparison_metrics', {}).get('impact_level', 'Unknown').upper()}")
        
        # Components Breakdown
        components = carbon_data.get('components', {})
        if components:
            print(f"\nüìà EMISSION BREAKDOWN:")
            print("-" * 40)
            for component, details in components.items():
                if isinstance(details, dict) and details.get('percentage', 0) > 0:
                    name = component.replace('_', ' ').title()
                    percentage = details.get('percentage', 0)
                    carbon_kg = details.get('carbon_kg', 0)
                    print(f"{name.ljust(20)}: {percentage:5.1f}% ({carbon_kg:.6f} kg CO2)")
        
        # Threshold Check
        threshold = float(os.environ.get('CARBON_THRESHOLD', '0.1'))
        current_carbon = carbon_data.get('total_carbon_kg', 0)
        print(f"\nüéØ THRESHOLD ANALYSIS:")
        print("-" * 40)
        print(f"Current Emissions: {current_carbon:.6f} kg CO2")
        print(f"Threshold Limit:   {threshold:.6f} kg CO2")
        
        if current_carbon > threshold:
            print(f"Status: ‚ö†Ô∏è  EXCEEDS THRESHOLD by {((current_carbon/threshold - 1) * 100):.1f}%")
            print("Action: Review optimization recommendations below")
        else:
            remaining = ((threshold - current_carbon) / threshold) * 100
            print(f"Status: ‚úÖ WITHIN THRESHOLD ({remaining:.1f}% remaining)")
        
        # Environmental Comparisons
        comparisons = carbon_data.get('comparison_metrics', {}).get('comparisons', {})
        if comparisons:
            print(f"\nüåç ENVIRONMENTAL COMPARISONS:")
            print("-" * 40)
            
            smartphone = comparisons.get('smartphone_charging', {})
            if smartphone:
                print(f"Smartphone Charges: {smartphone.get('value', 0):.1f}")
            
            car = comparisons.get('car_distance', {})
            if car:
                print(f"Car Distance:       {car.get('value', 0):.3f} km")
            
            light_bulb = comparisons.get('light_bulb', {})
            if light_bulb:
                print(f"60W Light Bulb:     {light_bulb.get('value', 0):.2f} hours")
            
            tree = comparisons.get('tree_absorption', {})
            if tree:
                print(f"Tree Absorption:    {tree.get('value', 0):.6f} years")
        
        # Optimization Recommendations
        recommendations = data.get('optimization_recommendations', [])
        if recommendations:
            print(f"\nüí° OPTIMIZATION RECOMMENDATIONS:")
            print("-" * 40)
            for i, rec in enumerate(recommendations[:5], 1):
                print(f"{i}. {rec}")
        
        # Framework Analysis
        frameworks = lang_analysis.get('frameworks', {})
        if frameworks:
            print(f"\nüîß DETECTED FRAMEWORKS:")
            print("-" * 40)
            for lang, fw_list in frameworks.items():
                if fw_list:
                    print(f"{lang.title()}: {', '.join(fw_list)}")
        
        print("\n" + "="*80)
        print("üìä For detailed interactive analysis, view the HTML report:")
        print("   - carbon-reports/complete_analysis.html")
        print("   - carbon-reports/executive_summary.html")
        print("="*80 + "\n")
        
    except FileNotFoundError:
        print("‚ùå Analysis results not found. Ensure the analysis completed successfully.")
    except json.JSONDecodeError:
        print("‚ùå Invalid JSON in analysis results.")
    except Exception as e:
        print(f"‚ùå Error displaying results: {e}")

if __name__ == "__main__":
    create_runtime_display()
EOF
        
        # Run the runtime display
        python ../show_runtime_report.py
        
      displayName: 'Show Runtime Report'
      
    - task: PublishHtmlReport@1
      displayName: 'Publish Carbon Footprint HTML Report'
      inputs:
        reportDir: '$(System.DefaultWorkingDirectory)/carbon-reports'
        tabName: 'Carbon Footprint Report'
      condition: always()
      
    - task: PublishTestResults@2
      displayName: 'Publish Carbon Analysis Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '$(System.DefaultWorkingDirectory)/carbon-reports/*.xml'
        mergeTestResults: true
        failTaskOnFailedTests: false
        testRunTitle: 'Carbon Footprint Analysis'
      condition: always()
      
    - task: PublishPipelineArtifact@1
      displayName: 'Archive Carbon Reports'
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/carbon-reports'
        artifact: 'carbon-footprint-reports'
      condition: always()
      
    - script: |
        echo "üåê REPORT ACCESSIBILITY"
        echo "======================"
        echo "üìä HTML Reports available in Pipeline Artifacts"
        echo "üìã JSON Data available for downstream processing"
        echo "üîç Detailed analysis available in published HTML report"
        echo ""
        echo "üîó Access Reports:"
        echo "   1. Click 'Carbon Footprint Report' tab above"
        echo "   2. Download 'carbon-footprint-reports' artifact"
        echo "   3. View complete_analysis.html for interactive dashboard"
        echo ""
        
        # Create summary for pipeline overview
        if [ -f "carbon-reports/complete_analysis.json" ]; then
          python3 -c "
import json
try:
    with open('carbon-reports/complete_analysis.json', 'r') as f:
        data = json.load(f)
    
    carbon_kg = data.get('carbon_footprint', {}).get('total_carbon_kg', 0)
    energy_kwh = data.get('carbon_footprint', {}).get('total_energy_kwh', 0)
    files = data.get('language_analysis', {}).get('total_files', 0)
    lang = data.get('language_analysis', {}).get('primary_language', 'Unknown')
    
    print('##vso[task.setvariable variable=CarbonFootprint;isOutput=true]{:.6f}'.format(carbon_kg))
    print('##vso[task.setvariable variable=EnergyUsage;isOutput=true]{:.6f}'.format(energy_kwh))
    print('##vso[task.setvariable variable=FilesAnalyzed;isOutput=true]{}'.format(files))
    print('##vso[task.setvariable variable=PrimaryLanguage;isOutput=true]{}'.format(lang))
    
    # Set build result based on threshold
    import os
    threshold = float(os.environ.get('CARBON_THRESHOLD', '0.1'))
    if carbon_kg > threshold:
        print('##vso[task.logissue type=warning]Carbon footprint {:.6f} kg CO2 exceeds threshold {:.6f} kg CO2'.format(carbon_kg, threshold))
        print('##vso[task.complete result=SucceededWithIssues;]Carbon analysis completed with threshold exceeded')
    else:
        print('##vso[task.logissue type=info]Carbon footprint {:.6f} kg CO2 is within threshold {:.6f} kg CO2'.format(carbon_kg, threshold))
        
except Exception as e:
    print('##vso[task.logissue type=error]Failed to set pipeline variables: {}'.format(e))
"
        fi
      displayName: 'Set Pipeline Summary'
      name: CarbonResults

- stage: DisplaySummary
  displayName: 'Pipeline Summary'
  dependsOn: CarbonFootprintAnalysis
  condition: always()
  jobs:
  - job: ShowSummary
    displayName: 'Show Carbon Analysis Summary'
    variables:
      CarbonFootprint: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.CarbonFootprint'] ]
      EnergyUsage: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.EnergyUsage'] ]
      FilesAnalyzed: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.FilesAnalyzed'] ]
      PrimaryLanguage: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.PrimaryLanguage'] ]
    
    steps:
    - script: |
        echo ""
        echo "üå± FINAL PIPELINE CARBON FOOTPRINT SUMMARY"
        echo "=========================================="
        echo "üìä Primary Language: $(PrimaryLanguage)"
        echo "üìÅ Files Analyzed: $(FilesAnalyzed)"
        echo "üå± Carbon Footprint: $(CarbonFootprint) kg CO2"
        echo "‚ö° Energy Usage: $(EnergyUsage) kWh"
        echo "üéØ Threshold: $(CARBON_THRESHOLD) kg CO2"
        echo ""
        
        # Check if we have valid data
        if [ "$(CarbonFootprint)" != "" ]; then
          echo "‚úÖ Carbon analysis completed successfully!"
          echo "üìã Detailed reports available in pipeline artifacts"
          echo "üåê Interactive dashboard in HTML report tab"
        else
          echo "‚ö†Ô∏è Carbon analysis data not available"
        fi
        
        echo ""
        echo "üîó Next Steps:"
        echo "1. Review detailed HTML report for optimization opportunities"
        echo "2. Download artifacts for offline analysis"
        echo "3. Integrate findings into development workflow"
        echo "4. Set up automated monitoring for future builds"
        echo ""
      displayName: 'Final Summary'