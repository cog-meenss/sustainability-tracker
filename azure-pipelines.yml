# Azure DevOps Pipeline for Carbon Footprint Analysis
# Performs comprehensive carbon footprint analysis on repository code
# Generates real-time reports with threshold checking and optimization recommendations

trigger:
- main
- master
- develop

variables:
  # Carbon threshold in kg CO2 - pipeline will show warning if exceeded
  CARBON_THRESHOLD: '0.1'
  
pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: CarbonFootprintAnalysis
  displayName: 'Carbon Footprint Analysis'
  jobs:
  - job: AnalyzeProject
    displayName: 'Analyze Project Carbon Footprint'
    
    steps:
    - checkout: self
      displayName: 'Checkout Repository'
      
    - script: |
        echo "üåç CARBON FOOTPRINT ANALYSIS PIPELINE"
        echo "====================================="
        echo "Repository: $(Build.Repository.Name)"
        echo "Branch: $(Build.SourceBranchName)"
        echo "Commit: $(Build.SourceVersion)"
        echo "Threshold: $(CARBON_THRESHOLD) kg CO2"
        echo ""
      displayName: 'Pipeline Information'
      
    - task: UsePythonVersion@0
      displayName: 'Setup Python'
      inputs:
        versionSpec: '3.x'
        addToPath: true
        
    - script: |
        python -m pip install --upgrade pip
        pip install requests pyyaml
      displayName: 'Install Dependencies'
      
    - script: |
        # Create carbon reports directory
        mkdir -p carbon-reports
        
        # Navigate to analyzer directory
        cd carbon-footprint-analyzer
        
        echo "üîç Starting Carbon Footprint Analysis..."
        echo "========================================"
        
        # Run the carbon footprint analyzer
        python3 carbon_analyzer.py --source .. --output ../carbon-reports --format json,html --detailed
        
      displayName: 'Run Carbon Footprint Analysis'
      
    - script: |
        cd carbon-footprint-analyzer
        
        # Extract key metrics using helper script
        python3 pipeline_helper.py
        
      displayName: 'Show Analysis Results'
      
    - script: |
        # Check if analysis completed successfully
        if [ -f "carbon-reports/complete_analysis.json" ]; then
          cd carbon-footprint-analyzer
          python3 pipeline_helper.py --set-variables
        fi
      displayName: 'Set Pipeline Summary'
      name: CarbonResults

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Carbon Footprint HTML Report'
      inputs:
        pathToPublish: '$(System.DefaultWorkingDirectory)/carbon-reports'
        artifactName: 'carbon-footprint-html-reports'
        publishLocation: 'Container'
      condition: always()
      
    - task: PublishTestResults@2
      displayName: 'Publish Carbon Analysis Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '$(System.DefaultWorkingDirectory)/carbon-reports/*.xml'
        mergeTestResults: true
        failTaskOnFailedTests: false
        testRunTitle: 'Carbon Footprint Analysis'
      condition: always()
      
    - task: PublishPipelineArtifact@1
      displayName: 'Archive Carbon Reports'
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/carbon-reports'
        artifact: 'carbon-footprint-reports'
      condition: always()
      
    - script: |
        echo "üåê REPORT ACCESSIBILITY"
        echo "======================"
        echo "üìä HTML Reports available in Pipeline Artifacts"
        echo "üìã JSON Data available for downstream processing"
        echo "üîç Detailed analysis available in published artifacts"
        echo ""
        echo "üîó Access Reports:"
        echo "   1. Go to Pipeline Summary ‚Üí Artifacts section"
        echo "   2. Download 'carbon-footprint-html-reports' artifact"
        echo "   3. Download 'carbon-footprint-reports' artifact"  
        echo "   4. Open complete_analysis.html for interactive dashboard"
        echo ""
        
      displayName: 'Report Access Information'

- stage: DisplaySummary
  displayName: 'Pipeline Summary'
  dependsOn: CarbonFootprintAnalysis
  condition: always()
  jobs:
  - job: ShowSummary
    displayName: 'Show Carbon Analysis Summary'
    variables:
      CarbonFootprint: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.CarbonFootprint'] ]
      EnergyUsage: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.EnergyUsage'] ]
      FilesAnalyzed: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.FilesAnalyzed'] ]
      PrimaryLanguage: $[ stageDependencies.CarbonFootprintAnalysis.AnalyzeProject.outputs['CarbonResults.PrimaryLanguage'] ]
    
    steps:
    - script: |
        echo ""
        echo "üéØ CARBON ANALYSIS PIPELINE SUMMARY"
        echo "===================================="
        echo "Carbon Footprint: $(CarbonFootprint) kg CO2"
        echo "Energy Usage:     $(EnergyUsage) kWh"
        echo "Files Analyzed:   $(FilesAnalyzed)"
        echo "Primary Language: $(PrimaryLanguage)"
        echo ""
        echo "Threshold:        $(CARBON_THRESHOLD) kg CO2"
        
        # Compare against threshold
        threshold=$(CARBON_THRESHOLD)
        current=$(CarbonFootprint)
        
        if (( $(echo "$current > $threshold" | bc -l) )); then
          echo "Status:           ‚ö†Ô∏è  EXCEEDS THRESHOLD"
          echo ""
          echo "üí° RECOMMENDATION:"
          echo "   Review the optimization recommendations in the detailed report"
          echo "   Consider implementing code efficiency improvements"
          echo "   Check for unnecessary computations or large data processing"
        else
          echo "Status:           ‚úÖ WITHIN THRESHOLD"
          echo ""
          echo "üåü GREAT JOB!"
          echo "   Your code has an efficient carbon footprint"
          echo "   Continue following sustainable coding practices"
        fi
        
        echo ""
        echo "üìã For detailed analysis, download the artifacts from the Pipeline Summary"
        echo "   ‚Üí Artifacts: 'carbon-footprint-html-reports' and 'carbon-footprint-reports'"
        echo "===================================="
        echo ""
        
      displayName: 'Pipeline Summary'
      condition: always()