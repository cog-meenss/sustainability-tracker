# ðŸŒ± Simplified Azure DevOps Pipeline for Sustainability Analysis
# Basic version without complex dependencies

trigger:
  branches:
    include:
    - main

variables:
  pythonVersion: '3.9'

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: self
  displayName: 'Checkout Source Code'

- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(pythonVersion)'
    addToPath: true
  displayName: 'Setup Python $(pythonVersion)'

- script: |
    echo "ðŸŒ± Installing basic dependencies..."
    python -m pip install --upgrade pip
    
    # Install only if requirements.txt exists
    if [ -f "sustainability-analyzer/requirements.txt" ]; then
        pip install -r sustainability-analyzer/requirements.txt
    else
        echo "âš ï¸ requirements.txt not found, installing basic packages"
        pip install pyyaml requests pandas matplotlib
    fi
    
    echo "âœ… Dependencies installed"
  displayName: 'Install Dependencies'
  continueOnError: true

- script: |
    echo "ðŸ“Š Running basic sustainability check..."
    echo "Project Path: $(Build.SourcesDirectory)"
    
    # Create output directory
    mkdir -p $(Build.ArtifactStagingDirectory)/reports
    
    # Simple analysis if analyzer exists
    if [ -f "sustainability-analyzer/analyzer/sustainability_analyzer.py" ]; then
        python sustainability-analyzer/analyzer/sustainability_analyzer.py \
          --path $(Build.SourcesDirectory) \
          --output $(Build.ArtifactStagingDirectory)/reports/basic-analysis.json \
          --format json || echo "âš ï¸ Analysis failed, continuing..."
    else
        echo "âš ï¸ Analyzer not found, creating placeholder report"
        echo '{"message": "Sustainability analyzer not configured", "timestamp": "'$(date)'"}' > $(Build.ArtifactStagingDirectory)/reports/basic-analysis.json
    fi
    
    echo "âœ… Analysis completed"
  displayName: 'Run Basic Analysis'
  continueOnError: true

- task: PublishBuildArtifacts@1
  condition: always()
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/reports'
    ArtifactName: 'BasicSustainabilityReports'
    publishLocation: 'Container'
  displayName: 'Publish Reports'