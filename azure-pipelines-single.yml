# üå± Azure DevOps Pipeline for Sustainability Analysis (Single Job - No Parallelism)
# Automated code sustainability evaluation with reporting

name: $(BuildDefinitionName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
    - main
    - develop
  paths:
    exclude:
    - README.md
    - docs/*

pr:
  branches:
    include:
    - main
    - develop
  paths:
    exclude:
    - README.md
    - docs/*

schedules:
- cron: "0 2 * * 1"  # Weekly analysis on Monday 2 AM UTC
  displayName: Weekly Sustainability Analysis
  branches:
    include:
    - main
  always: true

variables:
  - name: pythonVersion
    value: '3.9'
  - name: sustainabilityThreshold
    value: 75
  - name: reportFormat
    value: 'all'  # html, json, azure, all
  - name: TeamsWebhookUrl
    value: ''  # Optional: Add your Teams webhook URL here

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: self
  fetchDepth: 0
  displayName: 'Checkout Source Code'

- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(pythonVersion)'
    addToPath: true
    architecture: 'x64'
  displayName: 'Setup Python $(pythonVersion)'

- script: |
    echo "üå± Installing Sustainability Analyzer Dependencies..."
    python -m pip install --upgrade pip
    
    # Install requirements if file exists
    if [ -f "sustainability-analyzer/requirements.txt" ]; then
        pip install -r sustainability-analyzer/requirements.txt
    else
        echo "‚ö†Ô∏è requirements.txt not found, installing basic packages"
        pip install pyyaml requests pandas matplotlib plotly seaborn numpy
    fi
    
    echo "‚úÖ Dependencies installed successfully"
  displayName: 'Install Dependencies'
  continueOnError: true

- script: |
    echo "üìä Running Sustainability Analysis..."
    echo "Project Path: $(Build.SourcesDirectory)"
    echo "Report Output: $(Build.ArtifactStagingDirectory)/sustainability-reports"
    
    # Create reports directory
    mkdir -p $(Build.ArtifactStagingDirectory)/sustainability-reports
    
    # Run core sustainability analysis if analyzer exists
    if [ -f "sustainability-analyzer/analyzer/sustainability_analyzer.py" ]; then
        python sustainability-analyzer/analyzer/sustainability_analyzer.py \
          --path $(Build.SourcesDirectory) \
          --output $(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json \
          --format json || echo "‚ö†Ô∏è Analysis failed, continuing..."
        
        # Generate summary for pipeline
        python sustainability-analyzer/analyzer/sustainability_analyzer.py \
          --path $(Build.SourcesDirectory) \
          --format summary > $(Build.ArtifactStagingDirectory)/sustainability-reports/summary.txt || echo "‚ö†Ô∏è Summary generation failed"
    else
        echo "‚ö†Ô∏è Sustainability analyzer not found, creating basic report"
        echo '{"message": "Sustainability analyzer not configured", "timestamp": "'$(date)'", "overall_score": 50}' > $(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json
        echo "Sustainability analyzer not configured" > $(Build.ArtifactStagingDirectory)/sustainability-reports/summary.txt
    fi
    
    echo "‚úÖ Sustainability analysis completed"
  displayName: 'Run Sustainability Analysis'
  continueOnError: true

- script: |
    echo "üìà Generating Interactive Reports..."
    
    # Generate reports if generators exist
    if [ -f "sustainability-analyzer/reports/html_generator.py" ]; then
        python sustainability-analyzer/reports/html_generator.py \
          --input $(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json \
          --output $(Build.ArtifactStagingDirectory)/sustainability-reports/dashboard.html \
          --template comprehensive || echo "‚ö†Ô∏è HTML generation failed"
    fi
    
    if [ -f "sustainability-analyzer/reports/azure_publisher.py" ]; then
        python sustainability-analyzer/reports/azure_publisher.py \
          --input $(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json \
          --output $(Build.ArtifactStagingDirectory)/sustainability-reports/azure-report.html || echo "‚ö†Ô∏è Azure report generation failed"
    fi
    
    if [ -f "sustainability-analyzer/reports/executive_summary.py" ]; then
        python sustainability-analyzer/reports/executive_summary.py \
          --input $(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json \
          --output $(Build.ArtifactStagingDirectory)/sustainability-reports/executive-summary.pdf || echo "‚ö†Ô∏è Executive summary generation failed"
    fi
    
    echo "‚úÖ All reports generated successfully"
  displayName: 'Generate Reports'
  continueOnError: true

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      # Extract sustainability score for pipeline variables
      $analysisFile = "$(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json"
      
      if (Test-Path $analysisFile) {
          try {
              $analysis = Get-Content $analysisFile | ConvertFrom-Json
              
              # Handle different JSON structures
              if ($analysis.sustainability_metrics) {
                  $overallScore = [math]::Round($analysis.sustainability_metrics.overall_score, 1)
                  $energyScore = [math]::Round($analysis.sustainability_metrics.energy_efficiency, 1)
                  $resourceScore = [math]::Round($analysis.sustainability_metrics.resource_utilization, 1)
                  $carbonScore = [math]::Round($analysis.sustainability_metrics.carbon_footprint, 1)
              } elseif ($analysis.overall_score) {
                  $overallScore = [math]::Round($analysis.overall_score, 1)
                  $energyScore = 50
                  $resourceScore = 50
                  $carbonScore = 50
              } else {
                  $overallScore = 50
                  $energyScore = 50
                  $resourceScore = 50
                  $carbonScore = 50
              }
              
              Write-Host "##vso[task.setvariable variable=OverallSustainabilityScore]$overallScore"
              Write-Host "##vso[task.setvariable variable=EnergyEfficiencyScore]$energyScore"
              Write-Host "##vso[task.setvariable variable=ResourceUtilizationScore]$resourceScore"
              Write-Host "##vso[task.setvariable variable=CarbonFootprintScore]$carbonScore"
              
              Write-Host "üå± Sustainability Scores:"
              Write-Host "  Overall: $overallScore/100"
              Write-Host "  Energy Efficiency: $energyScore/100"
              Write-Host "  Resource Utilization: $resourceScore/100"
              Write-Host "  Carbon Footprint: $carbonScore/100"
              
              # Check if scores meet thresholds
              if ($overallScore -lt $(sustainabilityThreshold)) {
                  Write-Host "‚ö†Ô∏è Sustainability score ($overallScore) is below threshold ($(sustainabilityThreshold))"
                  Write-Host "##vso[task.setvariable variable=SustainabilityCheckPassed]false"
              } else {
                  Write-Host "‚úÖ Sustainability score meets threshold"
                  Write-Host "##vso[task.setvariable variable=SustainabilityCheckPassed]true"
              }
          } catch {
              Write-Host "‚ö†Ô∏è Error parsing analysis file: $_"
              Write-Host "##vso[task.setvariable variable=SustainabilityCheckPassed]false"
              Write-Host "##vso[task.setvariable variable=OverallSustainabilityScore]50"
          }
      } else {
          Write-Host "‚ùå Analysis file not found"
          Write-Host "##vso[task.setvariable variable=SustainabilityCheckPassed]false"
          Write-Host "##vso[task.setvariable variable=OverallSustainabilityScore]50"
      }
  displayName: 'Extract Sustainability Metrics'
  continueOnError: true

- script: |
    echo "üîç Quality Gate Evaluation:"
    echo "  Overall Score: $(OverallSustainabilityScore)"
    echo "  Required Threshold: $(sustainabilityThreshold)"
    echo "  Status: $(SustainabilityCheckPassed)"
    
    if [ "$(SustainabilityCheckPassed)" = "false" ]; then
        echo "##vso[task.logissue type=warning]Sustainability score ($(OverallSustainabilityScore)) is below required threshold ($(sustainabilityThreshold))"
        echo "##vso[task.logissue type=warning]Consider implementing the recommendations in the sustainability report"
    else
        echo "‚úÖ Sustainability quality gate passed!"
    fi
  displayName: 'Sustainability Quality Gate'
  continueOnError: true

- task: PublishTestResults@2
  condition: always()
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '$(Build.ArtifactStagingDirectory)/sustainability-reports/junit-results.xml'
    failTaskOnFailedTests: false
    testRunTitle: 'Sustainability Analysis Results'
  displayName: 'Publish Test Results'
  continueOnError: true

- task: PublishBuildArtifacts@1
  condition: always()
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/sustainability-reports'
    ArtifactName: 'SustainabilityReports'
    publishLocation: 'Container'
  displayName: 'Publish Sustainability Reports'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      # Create build summary with key metrics
      $summaryFile = "$(Agent.TempDirectory)/sustainability-summary.md"
      
      $overallScore = if ($env:OVERALLSUSTAINABILITYSCORE) { $env:OVERALLSUSTAINABILITYSCORE } else { "50" }
      $energyScore = if ($env:ENERGYEFFICIENCYSCORE) { $env:ENERGYEFFICIENCYSCORE } else { "50" }
      $resourceScore = if ($env:RESOURCEUTILIZATIONSCORE) { $env:RESOURCEUTILIZATIONSCORE } else { "50" }
      $carbonScore = if ($env:CARBONFOOTPRINTSCORE) { $env:CARBONFOOTPRINTSCORE } else { "50" }
      $checkPassed = if ($env:SUSTAINABILITYCHECKPASSED -eq 'true') { '‚úÖ PASSED' } else { '‚ùå FAILED' }
      
      @"
      # üå± Sustainability Analysis Results
      
      ## üìä Overall Score: $overallScore/100
      
      ### Detailed Metrics:
      - ‚ö° **Energy Efficiency**: $energyScore/100
      - üíæ **Resource Utilization**: $resourceScore/100  
      - üåç **Carbon Footprint**: $carbonScore/100 _(lower is better)_
      
      ### Quality Gate: $checkPassed
      
      üìà [View Detailed Dashboard]($(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts)
      
      ---
      _Generated on $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")_
      "@ | Out-File -FilePath $summaryFile -Encoding utf8
      
      Write-Host "##vso[task.uploadsummary]$summaryFile"
  env:
    OVERALLSUSTAINABILITYSCORE: $(OverallSustainabilityScore)
    ENERGYEFFICIENCYSCORE: $(EnergyEfficiencyScore)
    RESOURCEUTILIZATIONSCORE: $(ResourceUtilizationScore)
    CARBONFOOTPRINTSCORE: $(CarbonFootprintScore)
    SUSTAINABILITYCHECKPASSED: $(SustainabilityCheckPassed)
  displayName: 'Create Build Summary'
  continueOnError: true

- task: PowerShell@2
  condition: or(failed(), eq(variables['SustainabilityCheckPassed'], 'false'))
  inputs:
    targetType: 'inline'
    script: |
      # Teams notification for failed sustainability checks
      $teamsWebhook = $env:TEAMS_WEBHOOK_URL
      
      if ($teamsWebhook -and $teamsWebhook -ne '') {
          try {
              $message = @{
                  "@type" = "MessageCard"
                  "@context" = "https://schema.org/extensions"
                  "summary" = "Sustainability Analysis Alert"
                  "themeColor" = "FF6B35"
                  "sections" = @(
                      @{
                          "activityTitle" = "üå± Sustainability Analysis Alert"
                          "activitySubtitle" = "Build $(Build.BuildNumber)"
                          "facts" = @(
                              @{
                                  "name" = "Project"
                                  "value" = "$(Build.Repository.Name)"
                              },
                              @{
                                  "name" = "Overall Score"  
                                  "value" = "$(OverallSustainabilityScore)/100"
                              },
                              @{
                                  "name" = "Status"
                                  "value" = "‚ö†Ô∏è Below Threshold"
                              }
                          )
                      }
                  )
                  "potentialAction" = @(
                      @{
                          "@type" = "OpenUri"
                          "name" = "View Report"
                          "targets" = @(
                              @{
                                  "os" = "default"
                                  "uri" = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
                              }
                          )
                      }
                  )
              }
              
              $body = $message | ConvertTo-Json -Depth 10
              Invoke-RestMethod -Uri $teamsWebhook -Method Post -Body $body -ContentType "application/json"
              
              Write-Host "üì¢ Teams notification sent"
          } catch {
              Write-Host "‚ö†Ô∏è Failed to send Teams notification: $_"
          }
      } else {
          Write-Host "‚ÑπÔ∏è Teams webhook not configured, skipping notification"
      }
  env:
    TEAMS_WEBHOOK_URL: $(TeamsWebhookUrl)
  displayName: 'Send Teams Notification'
  continueOnError: true