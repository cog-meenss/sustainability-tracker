pipeline {
    agent any
    
    environment {
        CARBON_THRESHOLD = '0.1'
        CARBON_CONFIG = 'web_app_config.json'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'python3 -m pip install --user requests'
            }
        }
        
        stage('Carbon Analysis') {
            steps {
                script {
                    def result = sh(
                        script: 'python3 carbon-footprint-analyzer/examples/integrations/jenkins_integration.py',
                        returnStatus: true
                    )
                    
                    // Load analysis properties
                    def props = readProperties file: 'carbon_analysis.properties'
                    env.CARBON_KG = props.CARBON_KG
                    env.ENERGY_KWH = props.ENERGY_KWH
                    env.CARBON_IMPACT_LEVEL = props.CARBON_IMPACT_LEVEL
                    
                    // Handle result
                    if (result == 2) {
                        // Threshold exceeded - mark as unstable
                        currentBuild.result = 'UNSTABLE'
                        echo "⚠️ Carbon footprint exceeds threshold"
                    } else if (result == 1) {
                        // Analysis failed
                        currentBuild.result = 'FAILURE'
                        error("Carbon analysis failed")
                    } else {
                        echo "✅ Carbon analysis passed"
                    }
                }
            }
        }
    }
    
    post {
        always {
            // Archive reports
            archiveArtifacts artifacts: 'carbon-reports/**/*', allowEmptyArchive: true
            
            // Publish HTML reports
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'carbon-reports',
                reportFiles: '*.html',
                reportName: 'Carbon Footprint Report'
            ])
        }
        
        unstable {
            echo "⚠️ Carbon footprint exceeds threshold"
        }
        
        failure {
            echo "❌ Carbon analysis failed"
        }
    }
}