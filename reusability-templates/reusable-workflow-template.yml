# Reusable Sustainability Workflow Template
# Copy this file to .github/workflows/sustainability.yml in any project

name: ğŸŒ± Sustainability Analysis

on:
  workflow_call:
    inputs:
      project_type:
        description: 'Project type (python, javascript, java, go, mixed)'
        required: false
        default: 'mixed'
        type: string
      min_sustainability_score:
        description: 'Minimum sustainability score threshold'
        required: false
        default: 60
        type: number
      analysis_depth:
        description: 'Analysis depth (quick, standard, comprehensive)'
        required: false
        default: 'standard'
        type: string
      enable_security_scan:
        description: 'Enable security vulnerability scanning'
        required: false
        default: true
        type: boolean
      deploy_dashboard:
        description: 'Deploy results to GitHub Pages'
        required: false
        default: true
        type: boolean
    secrets:
      SLACK_WEBHOOK_URL:
        required: false
    outputs:
      sustainability_score:
        description: "Overall sustainability score"
        value: ${{ jobs.sustainability-analysis.outputs.score }}
      quality_gate_passed:
        description: "Whether quality gate passed"
        value: ${{ jobs.sustainability-analysis.outputs.quality_gate }}
      recommendations_count:
        description: "Number of recommendations"
        value: ${{ jobs.sustainability-analysis.outputs.recommendations }}

env:
  REPORT_PATH: 'sustainability-reports'
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  sustainability-analysis:
    name: ğŸŒ± Analyze Sustainability
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    outputs:
      score: ${{ steps.analysis.outputs.sustainability_score }}
      quality_gate: ${{ steps.analysis.outputs.quality_gate_passed }}
      recommendations: ${{ steps.analysis.outputs.recommendations_count }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Setup Python
      if: inputs.project_type == 'python' || inputs.project_type == 'mixed'
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸŸ¢ Setup Node.js  
      if: inputs.project_type == 'javascript' || inputs.project_type == 'mixed'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: |
        # Install based on project type
        if [[ "${{ inputs.project_type }}" == "python" || "${{ inputs.project_type }}" == "mixed" ]]; then
          pip install radon bandit safety pylint flake8 requests psutil
        fi
        
        if [[ "${{ inputs.project_type }}" == "javascript" || "${{ inputs.project_type }}" == "mixed" ]]; then
          npm install -g eslint jshint 2>/dev/null || echo "Node.js tools installation skipped"
        fi

    - name: ğŸ“Š Download Sustainability Evaluator
      run: |
        # Download the sustainability evaluator from template repository
        curl -sSL https://raw.githubusercontent.com/cog-meenss/sustainability-tracker/main/sustainability_evaluator.py -o sustainability_evaluator.py
        chmod +x sustainability_evaluator.py

    - name: ğŸŒ± Run Sustainability Analysis  
      id: analysis
      run: |
        mkdir -p ${{ env.REPORT_PATH }}
        
        # Configure analysis based on inputs
        ARGS="--path . --format both"
        
        if [[ "${{ inputs.analysis_depth }}" == "quick" ]]; then
          ARGS="$ARGS --quick"
        elif [[ "${{ inputs.analysis_depth }}" == "comprehensive" ]]; then
          ARGS="$ARGS --comprehensive"
        fi
        
        # Run analysis
        python3 sustainability_evaluator.py $ARGS --output ${{ env.REPORT_PATH }}/report || echo "Analysis completed with warnings"
        
        # Extract results if report exists
        if [ -f "${{ env.REPORT_PATH }}/report.json" ]; then
          SCORE=$(python3 -c "
import json
try:
    with open('${{ env.REPORT_PATH }}/report.json') as f:
        data = json.load(f)
        print(data.get('sustainability_metrics', {}).get('overall_score', 50))
except:
    print(50)
" 2>/dev/null)
          
          RECOMMENDATIONS=$(python3 -c "
import json
try:
    with open('${{ env.REPORT_PATH }}/report.json') as f:
        data = json.load(f)
        print(len(data.get('recommendations', [])))
except:
    print(0)
" 2>/dev/null)
          
          # Check quality gate
          if (( $(echo "$SCORE >= ${{ inputs.min_sustainability_score }}" | bc -l 2>/dev/null || echo "0") )); then
            QUALITY_GATE="true"
          else
            QUALITY_GATE="false"
          fi
          
          echo "sustainability_score=$SCORE" >> $GITHUB_OUTPUT
          echo "recommendations_count=$RECOMMENDATIONS" >> $GITHUB_OUTPUT
          echo "quality_gate_passed=$QUALITY_GATE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Analysis Results:"
          echo "  â€¢ Sustainability Score: $SCORE/${{ inputs.min_sustainability_score }}"
          echo "  â€¢ Quality Gate: $([ "$QUALITY_GATE" = "true" ] && echo "âœ… PASSED" || echo "âŒ FAILED")"
          echo "  â€¢ Recommendations: $RECOMMENDATIONS"
        else
          echo "âŒ Analysis report not generated"
          echo "sustainability_score=0" >> $GITHUB_OUTPUT
          echo "recommendations_count=0" >> $GITHUB_OUTPUT
          echo "quality_gate_passed=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”’ Security Scan
      if: inputs.enable_security_scan
      run: |
        mkdir -p ${{ env.REPORT_PATH }}/security
        
        # Python security scan
        if command -v bandit >/dev/null 2>&1; then
          bandit -r . -f json -o ${{ env.REPORT_PATH }}/security/bandit.json --exclude ".venv,node_modules" 2>/dev/null || true
        fi
        
        # Node.js security scan
        if [ -f "package.json" ] && command -v npm >/dev/null 2>&1; then
          npm audit --json > ${{ env.REPORT_PATH }}/security/npm-audit.json 2>/dev/null || true
        fi
        
        echo "ğŸ”’ Security scanning completed"

    - name: ğŸ“¤ Upload Analysis Results
      uses: actions/upload-artifact@v4
      with:
        name: sustainability-analysis-${{ github.sha }}
        path: ${{ env.REPORT_PATH }}/
        retention-days: 30

    - name: ğŸ’¬ PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        SCORE: ${{ steps.analysis.outputs.sustainability_score }}
        QUALITY_GATE: ${{ steps.analysis.outputs.quality_gate_passed }}
        RECOMMENDATIONS: ${{ steps.analysis.outputs.recommendations_count }}
      with:
        script: |
          const score = process.env.SCORE || '0';
          const passed = process.env.QUALITY_GATE === 'true';
          const recommendations = process.env.RECOMMENDATIONS || '0';
          
          const emoji = passed ? 'âœ…' : 'âŒ';
          const status = passed ? 'PASSED' : 'FAILED';
          
          const body = `## ğŸŒ± Sustainability Analysis Results
          
          ${emoji} **Quality Gate ${status}**
          
          | Metric | Value | Status |
          |--------|-------|--------|
          | ğŸŒ± Sustainability Score | **${score}/100** | ${score >= 60 ? 'âœ…' : 'âŒ'} |
          | ğŸ’¡ Recommendations | **${recommendations}** | ${recommendations <= 3 ? 'âœ…' : 'âš ï¸'} |
          | ğŸ¯ Quality Threshold | **${{ inputs.min_sustainability_score }}/100** | ${passed ? 'âœ…' : 'âŒ'} |
          
          ${passed ? 
            'ğŸ‰ Great work! Your code meets sustainability standards.' : 
            'ğŸ”§ Please review the sustainability recommendations to improve your score.'
          }
          
          ---
          *ğŸ¤– Generated by Reusable Sustainability Pipeline*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  deploy-dashboard:
    name: ğŸš€ Deploy Dashboard
    needs: sustainability-analysis
    if: inputs.deploy_dashboard && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“Š Download Analysis Results
      uses: actions/download-artifact@v4
      with:
        name: sustainability-analysis-${{ github.sha }}
        path: dashboard/
        
    - name: ğŸŒ Setup GitHub Pages
      uses: actions/configure-pages@v5
      
    - name: ğŸ—ï¸ Build Dashboard
      run: |
        # Create a simple dashboard if report exists
        if [ -f "dashboard/report.html" ]; then
          cp dashboard/report.html dashboard/index.html
        else
          # Create basic dashboard
          cat > dashboard/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Sustainability Dashboard</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
          </head>
          <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; background: linear-gradient(135deg, #667eea, #764ba2);">
            <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
              <h1>ğŸŒ± Sustainability Dashboard</h1>
              <p>Sustainability analysis completed. Check the Actions tab for detailed results.</p>
            </div>
          </body>
          </html>
        EOF
        fi
        
    - name: ğŸš€ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: dashboard/
        
    - name: ğŸŒ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4