# üå± Azure DevOps Pipeline for Sustainability Analysis
# Automated code sustainability evaluation with reporting

name: $(BuildDefinitionName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
    - main
    - develop
  paths:
    exclude:
    - README.md
    - docs/*

pr:
  branches:
    include:
    - main
    - develop
  paths:
    exclude:
    - README.md
    - docs/*

schedules:
- cron: "0 2 * * 1"  # Weekly analysis on Monday 2 AM UTC
  displayName: Weekly Sustainability Analysis
  branches:
    include:
    - main
  always: true

variables:
  - name: pythonVersion
    value: '3.9'
  - name: sustainabilityThreshold
    value: 75
  - name: reportFormat
    value: 'all'  # html, json, azure, all
  - name: TeamsWebhookUrl
    value: ''  # Optional: Add your Teams webhook URL here
  - name: TeamsWebhookUrl
    value: ''  # Optional: Add your Teams webhook URL here

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: SustainabilityAnalysis
  displayName: 'Code Sustainability Analysis'
  jobs:
  - job: SetupAndAnalyze
    displayName: 'Setup Environment & Run Analysis'
    
    steps:
    - checkout: self
      fetchDepth: 0
      displayName: 'Checkout Source Code'
    
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
        architecture: 'x64'
      displayName: 'Setup Python $(pythonVersion)'
    
    - script: |
        echo "üå± Installing Sustainability Analyzer Dependencies..."
        python -m pip install --upgrade pip
        pip install -r sustainability-analyzer/requirements.txt
        
        # Install additional analysis dependencies
        pip install matplotlib seaborn plotly pandas numpy
        
        echo "‚úÖ Dependencies installed successfully"
      displayName: 'Install Dependencies'
      failOnStderr: false
    
    - script: |
        echo "üìä Running Sustainability Analysis..."
        echo "Project Path: $(Build.SourcesDirectory)"
        echo "Report Output: $(Build.ArtifactStagingDirectory)/sustainability-reports"
        
        # Create reports directory
        mkdir -p $(Build.ArtifactStagingDirectory)/sustainability-reports
        
        # Run core sustainability analysis
        python sustainability-analyzer/analyzer/sustainability_analyzer.py \
          --path $(Build.SourcesDirectory) \
          --output $(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json \
          --format json
        
        # Generate summary for pipeline
        python sustainability-analyzer/analyzer/sustainability_analyzer.py \
          --path $(Build.SourcesDirectory) \
          --format summary > $(Build.ArtifactStagingDirectory)/sustainability-reports/summary.txt
        
        echo "‚úÖ Sustainability analysis completed"
      displayName: 'Run Sustainability Analysis'
      failOnStderr: false
    
    - script: |
        echo "üìà Generating Interactive Reports..."
        
        # Generate HTML dashboard
        python sustainability-analyzer/reports/html_generator.py \
          --input $(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json \
          --output $(Build.ArtifactStagingDirectory)/sustainability-reports/dashboard.html \
          --template comprehensive
        
        # Generate Azure DevOps compatible report
        python sustainability-analyzer/reports/azure_publisher.py \
          --input $(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json \
          --output $(Build.ArtifactStagingDirectory)/sustainability-reports/azure-report.html
        
        # Generate executive summary
        python sustainability-analyzer/reports/executive_summary.py \
          --input $(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json \
          --output $(Build.ArtifactStagingDirectory)/sustainability-reports/executive-summary.pdf
        
        echo "‚úÖ All reports generated successfully"
      displayName: 'Generate Reports'
      failOnStderr: false
    
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          # Extract sustainability score for pipeline variables
          $analysisFile = "$(Build.ArtifactStagingDirectory)/sustainability-reports/analysis.json"
          
          if (Test-Path $analysisFile) {
              $analysis = Get-Content $analysisFile | ConvertFrom-Json
              $overallScore = [math]::Round($analysis.sustainability_metrics.overall_score, 1)
              $energyScore = [math]::Round($analysis.sustainability_metrics.energy_efficiency, 1)
              $resourceScore = [math]::Round($analysis.sustainability_metrics.resource_utilization, 1)
              $carbonScore = [math]::Round($analysis.sustainability_metrics.carbon_footprint, 1)
              
              Write-Host "##vso[task.setvariable variable=OverallSustainabilityScore]$overallScore"
              Write-Host "##vso[task.setvariable variable=EnergyEfficiencyScore]$energyScore"
              Write-Host "##vso[task.setvariable variable=ResourceUtilizationScore]$resourceScore"
              Write-Host "##vso[task.setvariable variable=CarbonFootprintScore]$carbonScore"
              
              Write-Host "üå± Sustainability Scores:"
              Write-Host "  Overall: $overallScore/100"
              Write-Host "  Energy Efficiency: $energyScore/100"
              Write-Host "  Resource Utilization: $resourceScore/100"
              Write-Host "  Carbon Footprint: $carbonScore/100"
              
              # Check if scores meet thresholds
              if ($overallScore -lt $(sustainabilityThreshold)) {
                  Write-Host "‚ö†Ô∏è Sustainability score ($overallScore) is below threshold ($(sustainabilityThreshold))"
                  Write-Host "##vso[task.setvariable variable=SustainabilityCheckPassed]false"
              } else {
                  Write-Host "‚úÖ Sustainability score meets threshold"
                  Write-Host "##vso[task.setvariable variable=SustainabilityCheckPassed]true"
              }
          } else {
              Write-Host "‚ùå Analysis file not found"
              Write-Host "##vso[task.setvariable variable=SustainabilityCheckPassed]false"
          }
      displayName: 'Extract Sustainability Metrics'
    
    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '$(Build.ArtifactStagingDirectory)/sustainability-reports/junit-results.xml'
        failTaskOnFailedTests: false
        testRunTitle: 'Sustainability Analysis Results'
      displayName: 'Publish Test Results'
      continueOnError: true
    
    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/sustainability-reports'
        ArtifactName: 'SustainabilityReports'
        publishLocation: 'Container'
      displayName: 'Publish Sustainability Reports'
    
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          # Create build summary with key metrics
          $summaryFile = "$(Agent.TempDirectory)/sustainability-summary.md"
          
          @"
          # üå± Sustainability Analysis Results
          
          ## üìä Overall Score: $(OverallSustainabilityScore)/100
          
          ### Detailed Metrics:
          - ‚ö° **Energy Efficiency**: $(EnergyEfficiencyScore)/100
          - üíæ **Resource Utilization**: $(ResourceUtilizationScore)/100  
          - üåç **Carbon Footprint**: $(CarbonFootprintScore)/100 _(lower is better)_
          
          ### Quality Gate: $if($(SustainabilityCheckPassed) -eq 'true'){'‚úÖ PASSED'}else{'‚ùå FAILED'}
          
          üìà [View Detailed Dashboard]($(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts)
          
          ---
          _Generated on $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")_
          "@ | Out-File -FilePath $summaryFile -Encoding utf8
          
          Write-Host "##vso[task.uploadsummary]$summaryFile"
      displayName: 'Create Build Summary'

- stage: QualityGate
  displayName: 'Sustainability Quality Gate'
  dependsOn: SustainabilityAnalysis
  condition: always()
  
  jobs:
  - job: EvaluateQualityGate
    displayName: 'Evaluate Sustainability Thresholds'
    
    steps:
    - download: none
    
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $sustainabilityPassed = $env:SUSTAINABILITYCHECKPASSED
          $overallScore = $env:OVERALLSUSTAINABILITYSCORE
          $threshold = $env:SUSTAINABILITYTHRESHOLD
          
          Write-Host "üîç Quality Gate Evaluation:"
          Write-Host "  Overall Score: $overallScore"
          Write-Host "  Required Threshold: $threshold"
          Write-Host "  Status: $sustainabilityPassed"
          
          if ($sustainabilityPassed -eq 'false') {
              Write-Host "##vso[task.logissue type=warning]Sustainability score ($overallScore) is below required threshold ($threshold)"
              Write-Host "##vso[task.logissue type=warning]Consider implementing the recommendations in the sustainability report"
              
              # Optional: Fail the build if sustainability is critical
              # Write-Host "##vso[task.complete result=Failed]Sustainability quality gate failed"
          } else {
              Write-Host "‚úÖ Sustainability quality gate passed!"
          }
      env:
        SUSTAINABILITYCHECKPASSED: $(SustainabilityCheckPassed)
        OVERALLSUSTAINABILITYSCORE: $(OverallSustainabilityScore)
        SUSTAINABILITYTHRESHOLD: $(sustainabilityThreshold)
      displayName: 'Sustainability Quality Gate'

- stage: Notification
  displayName: 'Notification & Reporting'
  dependsOn: 
  - SustainabilityAnalysis
  - QualityGate
  condition: always()
  
  jobs:
  - job: SendNotifications
    displayName: 'Send Sustainability Notifications'
    condition: or(failed(), eq(variables['SustainabilityCheckPassed'], 'false'))
    
    steps:
    - download: none
    
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          # Teams notification for failed sustainability checks
          $teamsWebhook = $env:TEAMS_WEBHOOK_URL
          
          if ($teamsWebhook) {
              $message = @{
                  "@type" = "MessageCard"
                  "@context" = "https://schema.org/extensions"
                  "summary" = "Sustainability Analysis Alert"
                  "themeColor" = "FF6B35"
                  "sections" = @(
                      @{
                          "activityTitle" = "üå± Sustainability Analysis Alert"
                          "activitySubtitle" = "Build $(Build.BuildNumber)"
                          "facts" = @(
                              @{
                                  "name" = "Project"
                                  "value" = "$(Build.Repository.Name)"
                              },
                              @{
                                  "name" = "Overall Score"  
                                  "value" = "$(OverallSustainabilityScore)/100"
                              },
                              @{
                                  "name" = "Status"
                                  "value" = "‚ö†Ô∏è Below Threshold"
                              }
                          )
                      }
                  )
                  "potentialAction" = @(
                      @{
                          "@type" = "OpenUri"
                          "name" = "View Report"
                          "targets" = @(
                              @{
                                  "os" = "default"
                                  "uri" = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
                              }
                          )
                      }
                  )
              }
              
              $body = $message | ConvertTo-Json -Depth 10
              Invoke-RestMethod -Uri $teamsWebhook -Method Post -Body $body -ContentType "application/json"
              
              Write-Host "üì¢ Teams notification sent"
          }
      env:
        TEAMS_WEBHOOK_URL: $(TeamsWebhookUrl)
      displayName: 'Send Teams Notification'
      continueOnError: true